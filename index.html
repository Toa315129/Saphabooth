<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SENA OS 4.0 | CYBER-ARCHIVE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. KERNEL STYLES (VARS & RESET)
           ========================================= */
        :root {
            --h-primary: #00f3ff;   /* Cyan */
            --h-sec: #ff00ff;       /* Magenta */
            --h-alert: #ff2a2a;     /* Red */
            --h-warn: #fcee0a;      /* Yellow */
            --bg-deep: #050505;
            --bg-win: #121212;
            --glass: rgba(20, 20, 20, 0.95);
            --border: 1px solid #333;
            --font-ui: 'Rajdhani', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; padding: 0; background: #000; 
            overflow: hidden; height: 100vh; width: 100vw; 
            font-family: var(--font-ui); color: #fff; 
            cursor: default;
        }

        /* iPad Landscape Lock Simulation */
        @media screen and (orientation: portrait) {
            body::after {
                content: "PLEASE ROTATE DEVICE ‚Üª";
                position: fixed; inset: 0; background: #000; z-index: 99999;
                display: flex; align-items: center; justify-content: center;
                font-family: var(--font-code); color: var(--h-alert); font-size: 1.5rem;
            }
        }

        /* =========================================
           2. CRT & VISUAL FX
           ========================================= */
        #layer-crt { 
            position: fixed; inset: 0; pointer-events: none; z-index: 9000; mix-blend-mode: overlay; 
            background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%), 
                        linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06)); 
            background-size: 100% 3px, 3px 100%; 
        }
        #layer-vignette { 
            position: fixed; inset: 0; pointer-events: none; z-index: 8999; 
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.8) 100%); 
        }

        /* =========================================
           3. DESKTOP ENVIRONMENT
           ========================================= */
        #desktop { 
            position: absolute; inset: 0; 
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); 
            display: none; flex-direction: column; 
        }
        #desktop.active { display: flex; }

        /* Status Bar */
        .sys-bar { 
            height: 40px; background: rgba(0,0,0,0.8); border-bottom: 1px solid #333; 
            display: flex; align-items: center; padding: 0 20px; justify-content: space-between; 
            font-family: var(--font-code); font-size: 0.8rem; letter-spacing: 1px; color: var(--h-primary); 
        }
        
        /* Desktop Icons */
        .icon-grid { 
            flex: 1; padding: 40px; 
            display: flex; flex-direction: column; gap: 30px; align-items: flex-start;
        }
        .app-icon { 
            display: flex; align-items: center; gap: 15px; cursor: pointer; 
            transition: 0.2s; opacity: 0.7; 
        }
        .app-icon:hover { opacity: 1; transform: translateX(10px); }
        .app-icon:active { transform: scale(0.98); }
        
        .ico-box { 
            width: 70px; height: 70px; 
            border: 1px solid var(--h-primary); border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            background: rgba(0, 243, 255, 0.05); 
            box-shadow: 0 0 10px rgba(0,243,255,0.1); font-size: 2rem; 
        }
        .app-name { 
            font-size: 1.2rem; font-weight: 700; letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0,0,0,1); 
        }

        /* =========================================
           4. WINDOW SYSTEM
           ========================================= */
        .window { 
            position: absolute; background: var(--bg-win); 
            border: 1px solid #444; border-radius: 8px; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); 
            display: none; flex-direction: column; overflow: hidden;
            animation: winOpen 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .window.active { display: flex; z-index: 100; }
        @keyframes winOpen { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .win-header { 
            height: 40px; background: #1f1f1f; border-bottom: 1px solid #333; 
            display: flex; align-items: center; padding: 0 15px; justify-content: space-between;
            font-family: var(--font-code); font-size: 0.9rem; color: #888; cursor: default;
        }
        .win-controls { display: flex; gap: 8px; }
        .win-btn { width: 14px; height: 14px; border-radius: 50%; background: #444; cursor: pointer; }
        .win-btn.close { background: var(--h-alert); }
        .win-body { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }

        /* App Specific Windows */
        #win-camera { 
            inset: 40px 100px; /* Centered like a big app */
            border: 1px solid var(--h-primary); 
        }
        #win-editor { 
            inset: 20px 50px; 
            border: 1px solid var(--h-sec); z-index: 110; 
        }
        
        /* =========================================
           5. CAMERA APP UI
           ========================================= */
        .cam-layout { display: flex; height: 100%; }
        .cam-viewport { 
            flex: 1; background: #000; position: relative; 
            display: flex; justify-content: center; align-items: center; overflow: hidden; 
        }
        video#vid-stream { height: 100%; width: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* Grid Overlay */
        .cam-overlay { 
            position: absolute; inset: 0; pointer-events: none; 
            border: 20px solid #000; box-shadow: inset 0 0 0 2px rgba(255,255,255,0.2); 
            transition: 0.3s; 
        }
        .mode-4shot .cam-overlay { 
            background: linear-gradient(90deg, transparent 49%, rgba(255,255,255,0.3) 50%, transparent 51%), 
                        linear-gradient(0deg, transparent 49%, rgba(255,255,255,0.3) 50%, transparent 51%); 
        }

        .cam-sidebar { 
            width: 120px; background: #111; border-left: 1px solid #333; 
            display: flex; flex-direction: column; align-items: center; padding: 30px 0; gap: 20px; 
        }
        
        /* Controls */
        .ctrl-btn { 
            width: 70px; height: 70px; border-radius: 50%; border: 2px solid #444; 
            background: #222; color: #fff; font-size: 1.5rem; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; 
        }
        .ctrl-btn:active { transform: scale(0.9); }
        .ctrl-btn.active { border-color: var(--h-primary); color: var(--h-primary); background: rgba(0,243,255,0.1); }
        
        .shutter-btn { 
            width: 90px; height: 90px; border: 4px solid #fff; border-radius: 50%; 
            padding: 4px; cursor: pointer; margin-top: auto; 
        }
        .shutter-inner { width: 100%; height: 100%; background: #fff; border-radius: 50%; transition: 0.1s; }
        .shutter-btn:active .shutter-inner { transform: scale(0.85); background: var(--h-alert); }

        #countdown-layer { 
            position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); 
            font-size: 15rem; font-weight: 900; color: #fff; 
            text-shadow: 4px 4px 0 var(--h-primary); display: none; z-index: 50; 
        }

        /* =========================================
           6. EDITOR UI
           ========================================= */
        #editor-layout { display: flex; height: 100%; }
        
        /* Canvas Area */
        .editor-canvas-area { 
            flex: 1; background: #080808; 
            display: flex; justify-content: center; align-items: center; 
            position: relative; overflow: hidden;
            background-image: radial-gradient(#222 1px, transparent 1px); background-size: 20px 20px; /* Dot pattern */
        }
        canvas#main-canvas { 
            max-height: 90%; max-width: 90%; 
            box-shadow: 0 0 50px rgba(0,0,0,1); border: 1px solid #333; 
        }

        /* Tools Area */
        .editor-tools { 
            width: 350px; background: #181818; border-left: 1px solid #333; 
            display: flex; flex-direction: column; 
        }
        
        /* Tabs */
        .tool-tabs { display: flex; border-bottom: 1px solid #333; }
        .tab-btn { 
            flex: 1; padding: 15px; text-align: center; cursor: pointer; 
            font-family: var(--font-code); color: #666; font-size: 0.9rem; transition: 0.2s;
        }
        .tab-btn.active { background: #222; color: var(--h-sec); border-bottom: 2px solid var(--h-sec); }

        /* Panels */
        .tool-panel { flex: 1; padding: 20px; display: none; overflow-y: auto; flex-direction: column; gap: 15px; }
        .tool-panel.active { display: flex; }
        
        /* Filters List */
        .filter-item { 
            padding: 15px; background: #222; border: 1px solid #444; border-radius: 6px; 
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .filter-item:hover { border-color: #fff; }
        .filter-item.active { border-color: var(--h-primary); background: rgba(0,243,255,0.05); }
        .filter-name { font-family: var(--font-code); }

        /* Sticker Grid */
        .sticker-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .sticker-btn { 
            font-size: 2rem; background: #222; border-radius: 8px; padding: 10px; 
            cursor: pointer; text-align: center; transition: 0.2s; 
        }
        .sticker-btn:hover { background: #333; transform: scale(1.1); }

        /* Action Footer */
        .editor-footer { 
            padding: 20px; border-top: 1px solid #333; background: #111;
            display: flex; gap: 10px; 
        }
        .btn-full { 
            flex: 1; padding: 15px; border: none; font-weight: bold; font-family: var(--font-ui);
            cursor: pointer; font-size: 1rem; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .btn-cancel { background: #333; color: #fff; }
        .btn-print { background: var(--h-primary); color: #000; }
        .btn-print:hover { background: #fff; box-shadow: 0 0 20px var(--h-primary); }

        /* =========================================
           7. VIRTUAL KEYBOARD
           ========================================= */
        #vkb-container { 
            position: absolute; bottom: 0; left: 0; right: 0; height: 35vh; 
            background: #0f0f0f; border-top: 2px solid var(--h-sec); z-index: 500;
            display: flex; flex-direction: column; padding: 10px; 
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #vkb-container.show { transform: translateY(0); }
        
        .vkb-display { 
            background: #000; color: var(--h-sec); font-family: var(--font-code); font-size: 2rem;
            padding: 10px; margin-bottom: 10px; text-align: center; border: 1px solid #333;
        }
        .vkb-row { display: flex; justify-content: center; gap: 5px; flex: 1; margin-bottom: 5px; }
        .vkb-key { 
            background: #333; color: #fff; border-radius: 4px; flex: 1; margin: 0 2px;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            font-family: var(--font-code); cursor: pointer; box-shadow: 0 3px 0 #111;
        }
        .vkb-key:active { transform: translateY(3px); box-shadow: none; background: var(--h-sec); color: #000; }
        .vkb-key.action { background: #555; font-size: 1rem; flex: 1.5; }
        .vkb-key.enter { background: var(--h-primary); color: #000; flex: 2; font-weight: bold; }
        .vkb-key.space { flex: 4; }

        /* =========================================
           8. PRINT & QR MODAL
           ========================================= */
        #print-modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; align-items: center; justify-content: center; flex-direction: column; 
        }
        #print-modal.active { display: flex; }
        
        .paper-out { 
            width: 300px; background: #fff; padding: 15px; padding-bottom: 40px;
            transform: translateY(-100vh); transition: 1s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .paper-out.drop { transform: translateY(0); }
        .paper-out img { width: 100%; display: block; filter: contrast(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .qr-section { margin-top: 30px; text-align: center; opacity: 0; transition: 1s 2s; }
        .qr-section.show { opacity: 1; }
        #qrcode { background: #fff; padding: 10px; border-radius: 8px; display: inline-block; }
        .btn-restart { margin-top: 30px; padding: 15px 30px; background: transparent; border: 1px solid #fff; color: #fff; font-family: var(--font-code); cursor: pointer; }

        /* =========================================
           9. BOOT SCREEN
           ========================================= */
        #boot-screen { 
            position: fixed; inset: 0; background: #000; z-index: 10000; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .boot-text { font-family: var(--font-code); color: var(--h-primary); font-size: 1rem; line-height: 1.5; white-space: pre-wrap; width: 600px; }
        .cursor-blink { animation: blink 0.5s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body>

    <div id="layer-crt"></div>
    <div id="layer-vignette"></div>

    <div id="boot-screen">
        <div class="boot-text" id="boot-log"></div>
    </div>

    <div id="desktop">
        <div class="sys-bar">
            <span>SENA OS v4.0 [LANDSCAPE_EDITION]</span>
            <span id="clock">00:00</span>
        </div>

        <div class="icon-grid">
            <div class="app-icon" onclick="Sys.openApp('camera')">
                <div class="ico-box">üì∑</div>
                <div class="app-name">PHOTO_CAPTURE</div>
            </div>
            <div class="app-icon" onclick="alert('SYSTEM LOCKED')">
                <div class="ico-box" style="border-color:#555; color:#555">üìÇ</div>
                <div class="app-name" style="color:#555">ARCHIVES</div>
            </div>
             <div class="app-icon" onclick="location.reload()">
                <div class="ico-box" style="border-color:var(--h-alert); color:var(--h-alert)">üîå</div>
                <div class="app-name" style="color:var(--h-alert)">REBOOT</div>
            </div>
        </div>
    </div>

    <div id="win-camera" class="window">
        <div class="win-header">
            <span>// CAM_MODULE.EXE</span>
            <div class="win-controls"><div class="win-btn close" onclick="Sys.closeApp('camera')"></div></div>
        </div>
        <div class="win-body">
            <div class="cam-layout">
                <div class="cam-viewport">
                    <video id="vid-stream" autoplay playsinline muted></video>
                    <div id="cam-overlay" class="cam-overlay"></div>
                    <div id="countdown-layer">3</div>
                </div>
                <div class="cam-sidebar">
                    <div class="ctrl-btn" id="btn-mode-strip" onclick="Cam.setMode('strip')">I</div>
                    <div class="ctrl-btn" id="btn-mode-grid" onclick="Cam.setMode('grid')">Áî∞</div>
                    <div style="flex:1"></div>
                    <div class="shutter-btn" onclick="Cam.snap()">
                        <div class="shutter-inner"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="win-editor" class="window">
        <div class="win-header">
            <span>// EDITOR_SUITE.EXE</span>
            <div class="win-controls"></div>
        </div>
        <div class="win-body">
            <div id="editor-layout">
                <div class="editor-canvas-area">
                    <canvas id="main-canvas"></canvas>
                </div>
                <div class="editor-tools">
                    <div class="tool-tabs">
                        <div class="tab-btn active" onclick="Editor.setTab('filters', this)">FILTERS</div>
                        <div class="tab-btn" onclick="Editor.setTab('stickers', this)">STICKERS</div>
                        <div class="tab-btn" onclick="Editor.setTab('text', this)">TEXT</div>
                    </div>

                    <div id="panel-filters" class="tool-panel active">
                        <div class="filter-item active" onclick="Editor.setFilter('normal', this)">
                            <span class="filter-name">NORMAL</span>
                        </div>
                        <div class="filter-item" onclick="Editor.setFilter('bw', this)">
                            <span class="filter-name">MONO_CRUNCH</span>
                            <span style="font-size:0.8rem; color:#666">B/W</span>
                        </div>
                        <div class="filter-item" onclick="Editor.setFilter('cyber', this)">
                            <span class="filter-name">CYBER_PUNK</span>
                            <span style="font-size:0.8rem; color:var(--h-primary)">TEAL</span>
                        </div>
                        <div class="filter-item" onclick="Editor.setFilter('matrix', this)">
                            <span class="filter-name">MATRIX_CODE</span>
                            <span style="font-size:0.8rem; color:#0f0">GREEN</span>
                        </div>
                        <div class="filter-item" onclick="Editor.setFilter('love', this)">
                            <span class="filter-name">SWEET_HEART</span>
                            <span style="font-size:0.8rem; color:pink">PINK</span>
                        </div>
                    </div>

                    <div id="panel-stickers" class="tool-panel">
                        <div class="sticker-grid">
                            <div class="sticker-btn" onclick="Editor.addSticker('üíñ')">üíñ</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('üî•')">üî•</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('üëΩ')">üëΩ</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('‚ú®')">‚ú®</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('ü¶ã')">ü¶ã</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('üéÄ')">üéÄ</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('üåà')">üåà</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('üß∏')">üß∏</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('üí¢')">üí¢</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('üí§')">üí§</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('üëë')">üëë</div>
                            <div class="sticker-btn" onclick="Editor.addSticker('‚ò†Ô∏è')">‚ò†Ô∏è</div>
                        </div>
                        <button class="btn-full btn-cancel" onclick="Editor.clearStickers()" style="margin-top:10px">CLEAR ALL</button>
                    </div>

                    <div id="panel-text" class="tool-panel">
                        <p style="color:#666; font-size:0.8rem">CUSTOM MESSAGE:</p>
                        <button class="btn-full" style="background:#fff; color:#000; margin-bottom:10px" onclick="VirtKB.open()">OPEN KEYBOARD</button>
                        <button class="btn-full btn-cancel" onclick="Editor.setText('')">CLEAR TEXT</button>
                    </div>

                    <div style="flex:1"></div>
                    
                    <div class="editor-footer">
                        <button class="btn-full btn-cancel" onclick="Sys.reboot()">DISCARD</button>
                        <button class="btn-full btn-print" onclick="Editor.print()">PRINT >></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="vkb-container">
        <div class="vkb-display" id="vkb-input"></div>
        <div class="vkb-row">
            <div class="vkb-key" onclick="VirtKB.type('Q')">Q</div>
            <div class="vkb-key" onclick="VirtKB.type('W')">W</div>
            <div class="vkb-key" onclick="VirtKB.type('E')">E</div>
            <div class="vkb-key" onclick="VirtKB.type('R')">R</div>
            <div class="vkb-key" onclick="VirtKB.type('T')">T</div>
            <div class="vkb-key" onclick="VirtKB.type('Y')">Y</div>
            <div class="vkb-key" onclick="VirtKB.type('U')">U</div>
            <div class="vkb-key" onclick="VirtKB.type('I')">I</div>
            <div class="vkb-key" onclick="VirtKB.type('O')">O</div>
            <div class="vkb-key" onclick="VirtKB.type('P')">P</div>
        </div>
        <div class="vkb-row">
            <div class="vkb-key" onclick="VirtKB.type('A')">A</div>
            <div class="vkb-key" onclick="VirtKB.type('S')">S</div>
            <div class="vkb-key" onclick="VirtKB.type('D')">D</div>
            <div class="vkb-key" onclick="VirtKB.type('F')">F</div>
            <div class="vkb-key" onclick="VirtKB.type('G')">G</div>
            <div class="vkb-key" onclick="VirtKB.type('H')">H</div>
            <div class="vkb-key" onclick="VirtKB.type('J')">J</div>
            <div class="vkb-key" onclick="VirtKB.type('K')">K</div>
            <div class="vkb-key" onclick="VirtKB.type('L')">L</div>
        </div>
        <div class="vkb-row">
            <div class="vkb-key action" onclick="VirtKB.close()">EXIT</div>
            <div class="vkb-key" onclick="VirtKB.type('Z')">Z</div>
            <div class="vkb-key" onclick="VirtKB.type('X')">X</div>
            <div class="vkb-key" onclick="VirtKB.type('C')">C</div>
            <div class="vkb-key space" onclick="VirtKB.type(' ')">SPACE</div>
            <div class="vkb-key" onclick="VirtKB.type('V')">V</div>
            <div class="vkb-key" onclick="VirtKB.type('B')">B</div>
            <div class="vkb-key" onclick="VirtKB.type('N')">N</div>
            <div class="vkb-key" onclick="VirtKB.type('M')">M</div>
            <div class="vkb-key enter" onclick="VirtKB.confirm()">ENTER</div>
        </div>
    </div>

    <div id="print-modal">
        <div class="paper-out" id="paper-slot">
            <img id="final-img">
            <div style="text-align:center; font-family:var(--font-code); font-size:0.7rem; margin-top:10px; color:#000;">
                SENA OS v4.0 ‚Ä¢ TERMINAL_ID_01
            </div>
        </div>
        <div class="qr-section" id="qr-container">
            <div id="qrcode"></div>
            <div style="color:#fff; font-family:var(--font-code); margin-top:10px;">SCAN TO DOWNLOAD</div>
            <button class="btn-restart" onclick="location.reload()">START NEW SESSION</button>
        </div>
    </div>

    <script>
        /**
         * SENA OS 4.0 CORE KERNEL
         * Designed for iPad Landscape Web App
         */

        // --- 1. AUDIO ENGINE (Simple Oscillation) ---
        const Sfx = (function() {
            let ctx = null;
            function init() { if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)(); }
            
            function play(type) {
                if(!ctx) init();
                if(ctx.state === 'suspended') ctx.resume();
                const t = ctx.currentTime;
                const o = ctx.createOscillator();
                const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                
                if(type==='click') {
                    o.frequency.value = 1200; o.type = 'sine';
                    g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
                    o.start(); o.stop(t+0.1);
                } else if(type==='boot') {
                    o.frequency.value = 110; o.type = 'sawtooth';
                    o.frequency.linearRampToValueAtTime(880, t+0.5);
                    g.gain.value = 0.1;
                    o.start(); o.stop(t+1.5);
                } else if(type==='snap') {
                    o.frequency.value = 100; o.type = 'square';
                    g.gain.setValueAtTime(0.2, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.2);
                    o.start(); o.stop(t+0.2);
                }
            }
            return { play, init };
        })();

        // --- 2. SYSTEM MANAGER ---
        const Sys = (function() {
            const els = {
                boot: document.getElementById('boot-screen'),
                log: document.getElementById('boot-log'),
                desk: document.getElementById('desktop'),
                clock: document.getElementById('clock')
            };
            
            async function bootSequence() {
                const logs = [
                    "SENA KERNEL v4.0.12 INITIALIZING...",
                    "CPU: A-SERIES NEURAL ENGINE DETECTED",
                    "LOADING MODULES: [CAM] [GPU] [TOUCH]",
                    "MOUNTING FILE SYSTEM... OK",
                    "STARTING GUI SERVER..."
                ];
                
                let text = "";
                for(let l of logs) {
                    text += `> ${l}\n`;
                    els.log.innerText = text + "_";
                    await new Promise(r => setTimeout(r, 400));
                }
                Sfx.play('boot');
                await new Promise(r => setTimeout(r, 800));
                
                els.boot.style.display = 'none';
                els.desk.classList.add('active');
                startClock();
            }

            function startClock() {
                setInterval(() => {
                    const d = new Date();
                    els.clock.innerText = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0');
                }, 1000);
            }

            function openApp(id) {
                Sfx.play('click');
                document.getElementById('win-'+id).classList.add('active');
                if(id === 'camera') Cam.init();
            }

            function closeApp(id) {
                Sfx.play('click');
                document.getElementById('win-'+id).classList.remove('active');
                if(id === 'camera') Cam.stop();
            }

            return { boot: bootSequence, openApp, closeApp, reboot: ()=>location.reload() };
        })();

        // --- 3. CAMERA MODULE ---
        const Cam = (function() {
            let stream = null;
            let mode = 'strip'; // strip, grid
            let photos = [];
            const vid = document.getElementById('vid-stream');
            const overlay = document.getElementById('cam-overlay');
            const cnt = document.getElementById('countdown-layer');

            async function init() {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 1280, height: 720 } });
                    vid.srcObject = stream;
                } catch(e) { alert("Camera Permission Denied"); }
            }

            function stop() { if(stream) stream.getTracks().forEach(t=>t.stop()); }
            
            function setMode(m) {
                Sfx.play('click');
                mode = m;
                document.getElementById('btn-mode-strip').classList.toggle('active', m==='strip');
                document.getElementById('btn-mode-grid').classList.toggle('active', m==='grid');
                if(m==='grid') overlay.classList.add('mode-4shot');
                else overlay.classList.remove('mode-4shot');
            }

            async function snap() {
                photos = [];
                const shots = (mode === 'strip') ? 3 : 4;
                
                for(let i=0; i<shots; i++) {
                    await countdown(3);
                    Sfx.play('snap');
                    
                    // Flash
                    const f = document.createElement('div');
                    f.style.position='fixed'; f.style.inset='0'; f.style.background='#fff'; f.style.zIndex='9999';
                    document.body.appendChild(f);
                    setTimeout(()=>f.remove(), 100);
                    
                    // Capture
                    const c = document.createElement('canvas');
                    c.width = vid.videoWidth; c.height = vid.videoHeight;
                    const ctx = c.getContext('2d');
                    ctx.translate(c.width, 0); ctx.scale(-1, 1);
                    ctx.drawImage(vid, 0, 0);
                    photos.push(c);

                    await new Promise(r => setTimeout(r, 1000));
                }
                
                Sys.closeApp('camera');
                Sys.openApp('editor');
                setTimeout(() => Editor.load(photos, mode), 500);
            }

            function countdown(n) {
                return new Promise(r => {
                    let c = n; cnt.style.display='block'; cnt.innerText=c;
                    const t = setInterval(()=>{
                        c--; Sfx.play('click');
                        if(c>0) cnt.innerText=c;
                        else { clearInterval(t); cnt.style.display='none'; r(); }
                    }, 1000);
                });
            }

            return { init, stop, setMode, snap };
        })();

        // --- 4. EDITOR ENGINE (Heavy Logic) ---
        const Editor = (function() {
            const canvas = document.getElementById('main-canvas');
            const ctx = canvas.getContext('2d');
            
            // State
            let rawPhotos = [];
            let currentMode = '';
            let filter = 'normal';
            let stickers = []; // {t: text, x, y, r}
            let customText = '';
            
            // Config
            const W_STRIP = 600; 
            const W_GRID = 1200; 
            const P_H = 450; // 4:3 Aspect
            const GAP = 30;

            function load(photos, mode) {
                rawPhotos = photos; currentMode = mode;
                stickers = []; customText = ''; filter = 'normal';
                
                // Canvas Size Setup
                if(mode === 'strip') {
                    canvas.width = W_STRIP;
                    canvas.height = 300 + (3*P_H) + (2*GAP) + 200; // Header + 3Photos + Footer
                } else {
                    canvas.width = W_GRID;
                    canvas.height = 300 + (2*P_H) + GAP + 200; // Header + 2Rows + Footer
                }
                render();
            }

            function render() {
                const w = canvas.width; const h = canvas.height;
                
                // 1. Background Fill
                ctx.fillStyle = '#f5f5f5';
                if(filter === 'cyber') ctx.fillStyle = '#050505';
                if(filter === 'matrix') ctx.fillStyle = '#001100';
                if(filter === 'love') ctx.fillStyle = '#fff0f5';
                ctx.fillRect(0,0,w,h);

                // 2. Draw Header
                ctx.textAlign = 'center'; 
                if(filter === 'cyber') {
                    ctx.fillStyle = '#00f3ff'; ctx.font = 'bold 80px Rajdhani'; ctx.fillText('SENA OS', w/2, 120);
                } else if(filter === 'matrix') {
                    ctx.fillStyle = '#0f0'; ctx.font = '60px monospace'; ctx.fillText('SYSTEM_LOG', w/2, 120);
                } else {
                    ctx.fillStyle = '#111'; ctx.font = 'bold 80px Rajdhani'; ctx.fillText('SENA', w/2, 100);
                    ctx.font = '40px Rajdhani'; ctx.fillText('PHOTOBOOTH', w/2, 150);
                }

                // 3. Draw Photos
                rawPhotos.forEach((img, i) => {
                    let x, y, pw=600, ph=450; // Default Strip
                    if(currentMode === 'strip') {
                        x = (w-pw)/2;
                        y = 250 + i*(ph+GAP);
                    } else {
                        // Grid 2x2
                        pw = 580; ph = 435;
                        let col = i%2; let row = Math.floor(i/2);
                        x = 15 + col*(pw+10);
                        y = 250 + row*(ph+10);
                    }
                    
                    // Draw Frame Border
                    ctx.save();
                    if(filter === 'bw') { ctx.filter = 'grayscale(100%) contrast(1.2)'; }
                    if(filter === 'cyber') { ctx.filter = 'contrast(1.2) hue-rotate(180deg)'; ctx.strokeStyle='#00f3ff'; ctx.lineWidth=4; ctx.strokeRect(x,y,pw,ph); }
                    if(filter === 'matrix') { ctx.filter = 'grayscale(100%) sepia(100%) hue-rotate(90deg)'; ctx.strokeStyle='#0f0'; ctx.lineWidth=2; ctx.strokeRect(x,y,pw,ph); }
                    
                    ctx.drawImage(img, x, y, pw, ph);
                    ctx.restore();
                });

                // 4. Draw Stickers
                ctx.textAlign = 'center'; ctx.textBaseline='middle'; ctx.font='80px serif';
                stickers.forEach(s => {
                    ctx.fillText(s.t, s.x, s.y);
                });

                // 5. Draw Custom Text
                if(customText) {
                    ctx.fillStyle = (filter==='cyber'?'#ff00ff':'#333');
                    ctx.font = 'bold 50px monospace';
                    ctx.fillText(customText, w/2, h - 120);
                }

                // 6. Footer Date
                ctx.font = '24px monospace'; ctx.fillStyle = '#888';
                ctx.fillText(new Date().toLocaleString(), w/2, h-40);
            }

            // Public Methods
            return {
                load,
                setTab: (name, el) => {
                    Sfx.play('click');
                    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
                    el.classList.add('active');
                    document.querySelectorAll('.tool-panel').forEach(p=>p.classList.remove('active'));
                    document.getElementById('panel-'+name).classList.add('active');
                },
                setFilter: (name, el) => {
                    Sfx.play('click');
                    filter = name;
                    document.querySelectorAll('.filter-item').forEach(b=>b.classList.remove('active'));
                    el.classList.add('active');
                    render();
                },
                addSticker: (emoji) => {
                    // Random pos inside center area
                    const x = canvas.width/2 + (Math.random()*200-100);
                    const y = canvas.height/2 + (Math.random()*400-200);
                    stickers.push({t:emoji, x, y});
                    render();
                },
                clearStickers: () => { stickers = []; render(); },
                setText: (txt) => { customText = txt; render(); },
                print: () => {
                    const url = canvas.toDataURL('image/jpeg', 0.9);
                    const finalImg = document.getElementById('final-img');
                    finalImg.src = url;
                    
                    document.getElementById('print-modal').classList.add('active');
                    // Print Animation
                    setTimeout(() => {
                        document.getElementById('paper-slot').classList.add('drop');
                        Sfx.play('click'); // Simulated print sound trigger
                    }, 500);

                    // Generate QR
                    const qrDiv = document.getElementById('qrcode');
                    qrDiv.innerHTML = '';
                    new QRCode(qrDiv, { text: url.substring(0,500), width: 128, height: 128 }); // Note: Large base64 urls often fail in free QR libs, usually upload first in backend
                    
                    setTimeout(() => document.getElementById('qr-container').classList.add('show'), 2000);
                }
            };
        })();

        // --- 5. VIRTUAL KEYBOARD ---
        const VirtKB = (function() {
            const el = document.getElementById('vkb-container');
            const disp = document.getElementById('vkb-input');
            let buffer = "";

            return {
                open: () => { buffer=""; disp.innerText="_"; el.classList.add('show'); },
                close: () => { el.classList.remove('show'); },
                type: (char) => {
                    Sfx.play('click');
                    buffer += char;
                    disp.innerText = buffer + "_";
                },
                confirm: () => {
                    Sfx.play('click');
                    Editor.setText(buffer);
                    el.classList.remove('show');
                }
            };
        })();

        // START
        window.onload = Sys.boot;

    </script>
</body>
</html>
