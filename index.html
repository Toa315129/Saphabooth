<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENA SYSTEM | OS 3.0 ULTIMATE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">

    <style>
        /* --- 1. CORE SYSTEM STYLES --- */
        :root {
            --bg: #050505;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.2);
            --primary: #FFFFFF;
            --accent: #00FF94; /* Cyber Green */
            --alert: #FF2A6D;
            --font-main: 'Space Grotesk', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg);
            color: var(--primary);
            font-family: var(--font-main);
            height: 100vh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- 2. CRT & OVERLAYS --- */
        .scanlines {
            position: fixed; inset: 0; pointer-events: none; z-index: 900;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
        }
        .vignette {
            position: fixed; inset: 0; pointer-events: none; z-index: 901;
            background: radial-gradient(circle, rgba(0,0,0,0) 50%, rgba(0,0,0,0.8) 100%);
        }
        .noise {
            position: fixed; inset: 0; pointer-events: none; z-index: 899; opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- 3. UI LAYOUT --- */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 10; padding: 20px;
        }
        .screen.active { opacity: 1; pointer-events: auto; z-index: 100; }

        /* --- SCREEN: STANDBY --- */
        #s-standby { justify-content: center; align-items: center; text-align: center; }
        .logo-box {
            border: 1px solid var(--primary); padding: 40px;
            position: relative; margin-bottom: 40px;
        }
        .logo-box::before { content:''; position:absolute; top:-5px; left:-5px; width:10px; height:10px; background:var(--primary); }
        .logo-box::after { content:''; position:absolute; bottom:-5px; right:-5px; width:10px; height:10px; background:var(--primary); }
        
        h1 { font-family: var(--font-code); font-size: 4rem; margin: 0; letter-spacing: -2px; line-height: 0.9; }
        h2 { font-family: var(--font-code); font-size: 1rem; letter-spacing: 5px; color: var(--accent); margin-top: 10px; }
        
        .btn-start {
            background: var(--primary); color: #000;
            border: none; padding: 20px 60px;
            font-family: var(--font-code); font-weight: 800; font-size: 1.5rem;
            cursor: pointer; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: 0.2s;
        }
        .btn-start:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--accent); }
        .btn-start:active { transform: scale(0.95); }

        /* --- SCREEN: CAMERA & UI --- */
        #s-capture { padding: 0; background: #000; }
        .cam-header {
            height: 60px; background: #000; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; font-family: var(--font-code); color: var(--accent);
        }
        .cam-view {
            flex: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; background: #111;
        }
        video { height: 100%; width: auto; min-width: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .grid-overlay {
            position: absolute; inset: 0; pointer-events: none;
            background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 33.33% 33.33%;
        }

        #countdown {
            position: absolute; top:50%; left:50%; transform: translate(-50%,-50%);
            font-size: 10rem; font-weight: 800; color: #fff;
            text-shadow: 0 0 30px var(--alert); display: none;
        }

        .cam-controls {
            height: 140px; background: #000; border-top: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 15px; padding-bottom: 20px;
        }
        
        /* Filter Selector */
        .filter-bar { display: flex; gap: 10px; margin-bottom: 5px; }
        .f-btn {
            background: #222; border: 1px solid #444; color: #888;
            padding: 5px 15px; font-family: var(--font-code); font-size: 0.8rem;
            cursor: pointer; border-radius: 20px; transition: 0.2s;
        }
        .f-btn.active { background: var(--primary); color: #000; border-color: #fff; }

        /* Shutter */
        .shutter {
            width: 70px; height: 70px; border-radius: 50%;
            border: 3px solid #fff; position: relative; cursor: pointer;
        }
        .shutter::after {
            content:''; position: absolute; top:50%; left:50%; transform: translate(-50%,-50%);
            width: 60px; height: 60px; background: #fff; border-radius: 50%; transition: 0.1s;
        }
        .shutter:active::after { width: 50px; height: 50px; background: var(--alert); }

        /* --- SCREEN: PROCESSING & RESULT --- */
        #s-result { background: #080808; align-items: center; justify-content: center; }
        
        .printer-machine {
            position: relative; width: 320px; height: 60vh;
            background: #111; border: 1px solid #333;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            border-radius: 5px; overflow: hidden; /* Mask */
            margin-bottom: 20px;
        }
        .paper-slot {
            position: absolute; bottom: 0; left: 10px; right: 10px; height: 5px;
            background: #000; box-shadow: inset 0 2px 5px rgba(0,0,0,1); z-index: 20;
        }
        .photo-strip {
            width: 100%; display: block;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transform: translateY(-105%); /* Hidden inside/above */
            transition: transform 3.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .photo-strip.printed { transform: translateY(0); }

        .loading-ui {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 50; transition: opacity 0.5s;
        }
        .bar { width: 200px; height: 2px; background: #333; margin-top: 20px; position: relative; overflow: hidden; }
        .bar-fill { position: absolute; top:0; left:0; height:100%; width: 0%; background: var(--accent); transition: width 0.3s; }
        .status-txt { font-family: var(--font-code); color: var(--accent); font-size: 0.9rem; margin-top: 10px; }

        .result-actions {
            width: 100%; max-width: 400px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            opacity: 0; transition: 1s; transform: translateY(20px);
        }
        .result-actions.show { opacity: 1; transform: translateY(0); }

        .qr-box {
            background: #fff; padding: 10px; border-radius: 4px;
            display: flex; gap: 15px; align-items: center; width: 100%;
        }
        #qrcode { width: 80px; height: 80px; flex-shrink: 0; }
        .qr-info h3 { color: #000; margin: 0; font-size: 1rem; font-weight: 800; }
        .qr-info p { color: #555; margin: 5px 0 0; font-size: 0.75rem; font-family: var(--font-code); }

        .btn-restart {
            background: transparent; color: #666; border: 1px solid #333;
            padding: 10px 30px; font-family: var(--font-code); cursor: pointer;
            width: 100%; transition: 0.2s;
        }
        .btn-restart:hover { color: #fff; border-color: #fff; }

        /* Flash */
        .flash-overlay {
            position: fixed; inset: 0; background: #fff; z-index: 999;
            opacity: 0; pointer-events: none; transition: opacity 0.1s;
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="vignette"></div>
    <div class="noise"></div>
    <div class="flash-overlay" id="flash"></div>

    <div id="s-standby" class="screen active">
        <div class="logo-box">
            <h1>SENA<br>PHOTO</h1>
            <h2>SYSTEM OS 3.0</h2>
        </div>
        <button class="btn-start" onclick="App.init()">TOUCH TO START</button>
        <div style="margin-top:20px; font-family:var(--font-code); font-size:0.7rem; color:#444;">
            SECURE CONNECTION :: READY
        </div>
    </div>

    <div id="s-capture" class="screen">
        <div class="cam-header">
            <span>REC :: <span id="frame-count">0</span>/3</span>
            <span style="color:var(--alert)">LIVE</span>
        </div>
        <div class="cam-view">
            <video id="video" autoplay playsinline muted></video>
            <div class="grid-overlay"></div>
            <div id="countdown">3</div>
        </div>
        <div class="cam-controls">
            <div class="filter-bar">
                <div class="f-btn active" onclick="App.setFilter('normal', this)">NORM</div>
                <div class="f-btn" onclick="App.setFilter('bw', this)">B/W</div>
                <div class="f-btn" onclick="App.setFilter('1990', this)">1990</div>
                <div class="f-btn" onclick="App.setFilter('cyber', this)">CYBER</div>
            </div>
            <div class="shutter" onclick="App.snapSequence()"></div>
        </div>
    </div>

    <div id="s-result" class="screen">
        <div class="printer-machine">
            <img id="final-strip" class="photo-strip" alt="Printing...">
            <div class="paper-slot"></div>
            
            <div class="loading-ui" id="loader">
                <div style="font-family: var(--font-code); letter-spacing: 2px;">PROCESSING</div>
                <div class="bar"><div class="bar-fill" id="progress"></div></div>
                <div class="status-txt" id="status-msg">INITIALIZING...</div>
            </div>
        </div>

        <div class="result-actions" id="res-actions">
            <div class="qr-box">
                <div id="qrcode"></div>
                <div class="qr-info">
                    <h3>SCAN ME</h3>
                    <p>Download your high-res photo strip.</p>
                </div>
            </div>
            <button class="btn-restart" onclick="location.reload()">NEW SESSION</button>
        </div>
    </div>

    <canvas id="c-proc" style="display:none;"></canvas>

    <script>
        const App = (function() {
            // Configuration
            const CFG = {
                apiKey: 'ffc90ad0bc5c7e0c056b68ef7430304a', // Your Key
                width: 1280, height: 720, // Camera Res
                stripW: 800, // High Res Output Width
                shots: 3
            };

            const S = {
                stream: null,
                photos: [],
                filter: 'normal',
                isShooting: false
            };

            const El = {
                screens: {
                    standby: document.getElementById('s-standby'),
                    capture: document.getElementById('s-capture'),
                    result: document.getElementById('s-result')
                },
                video: document.getElementById('video'),
                flash: document.getElementById('flash'),
                count: document.getElementById('countdown'),
                canvas: document.getElementById('c-proc'),
                strip: document.getElementById('final-strip'),
                loader: document.getElementById('loader'),
                progress: document.getElementById('progress'),
                status: document.getElementById('status-msg'),
                actions: document.getElementById('res-actions'),
                frameCount: document.getElementById('frame-count')
            };

            // --- AUDIO ENGINE (Synthesized) ---
            const AudioEngine = {
                ctx: null,
                init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
                beep() {
                    this.init();
                    const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    o.frequency.value=1000; g.gain.value=0.1;
                    o.start(); o.stop(this.ctx.currentTime+0.1);
                },
                shutter() {
                    this.init();
                    const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                    o.type='square'; o.frequency.value=100;
                    o.connect(g); g.connect(this.ctx.destination);
                    g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+0.15);
                    o.start(); o.stop(this.ctx.currentTime+0.15);
                },
                printNoise() {
                    this.init();
                    const o=this.ctx.createOscillator(); const g=this.ctx.createGain();
                    o.type='sawtooth'; o.frequency.value=50;
                    o.connect(g); g.connect(this.ctx.destination);
                    g.gain.value=0.05;
                    o.start(); o.stop(this.ctx.currentTime+2.5);
                }
            };

            // --- CORE FUNCTIONS ---
            async function init() {
                AudioEngine.init();
                try {
                    S.stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'user', width: CFG.width, height: CFG.height },
                        audio: false
                    });
                    El.video.srcObject = S.stream;
                    switchScreen('capture');
                } catch(e) {
                    alert('Error: Camera Access Denied or Not Available via HTTP');
                }
            }

            function switchScreen(name) {
                Object.values(El.screens).forEach(s => s.classList.remove('active'));
                El.screens[name].classList.add('active');
            }

            function setFilter(name, btn) {
                S.filter = name;
                document.querySelectorAll('.f-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // CSS Preview
                let css = 'none';
                if(name==='bw') css='grayscale(1) contrast(1.2)';
                if(name==='1990') css='sepia(0.4) contrast(0.9) brightness(1.1)';
                if(name==='cyber') css='saturate(2) contrast(1.3) hue-rotate(-10deg)';
                El.video.style.filter = css;
                AudioEngine.beep();
            }

            // --- CAPTURE SEQUENCE ---
            async function snapSequence() {
                if(S.isShooting) return;
                S.isShooting = true;
                S.photos = [];
                El.frameCount.innerText = '0';

                for(let i=1; i<=CFG.shots; i++) {
                    await countdown(3);
                    await capturePhoto();
                    El.frameCount.innerText = i;
                    await new Promise(r => setTimeout(r, 800)); // Review time
                }
                
                finishSession();
            }

            function countdown(n) {
                return new Promise(r => {
                    let c = n;
                    El.count.style.display = 'block';
                    El.count.innerText = c;
                    const t = setInterval(() => {
                        AudioEngine.beep();
                        c--;
                        if(c>0) El.count.innerText=c;
                        else {
                            clearInterval(t);
                            El.count.style.display='none';
                            r();
                        }
                    }, 1000);
                });
            }

            function capturePhoto() {
                return new Promise(r => {
                    AudioEngine.shutter();
                    // Flash
                    El.flash.style.opacity = 1;
                    setTimeout(() => El.flash.style.opacity = 0, 150);

                    // Capture Frame
                    const cvs = document.createElement('canvas');
                    cvs.width = El.video.videoWidth;
                    cvs.height = El.video.videoHeight;
                    const ctx = cvs.getContext('2d');
                    
                    // Mirror & Draw
                    ctx.translate(cvs.width, 0); ctx.scale(-1, 1);
                    
                    // Apply Canvas Filters (matching CSS)
                    if(S.filter==='bw') ctx.filter = 'grayscale(1) contrast(1.2)';
                    if(S.filter==='1990') ctx.filter = 'sepia(0.4) contrast(0.9) brightness(1.1)';
                    if(S.filter==='cyber') ctx.filter = 'saturate(2) contrast(1.3) hue-rotate(-10deg)';
                    
                    ctx.drawImage(El.video, 0, 0);
                    S.photos.push(cvs);
                    r();
                });
            }

            // --- RENDERING & UPLOAD ---
            async function finishSession() {
                if(S.stream) S.stream.getTracks().forEach(t => t.stop());
                switchScreen('result');
                
                // 1. GENERATE STRIP
                updateStatus(10, "GENERATING LAYOUT...");
                const finalCanvas = await generateStripCanvas();
                const dataUrl = finalCanvas.toDataURL('image/jpeg', 0.95);
                
                El.strip.src = dataUrl;
                
                // 2. PRINT ANIMATION
                updateStatus(30, "PRINTING...");
                AudioEngine.printNoise();
                setTimeout(() => {
                    El.strip.classList.add('printed');
                }, 100);

                // 3. UPLOAD TO CLOUD
                updateStatus(50, "UPLOADING TO CLOUD...");
                try {
                    const url = await uploadToImgBB(dataUrl);
                    updateStatus(100, "COMPLETE");
                    
                    // 4. SHOW QR
                    new QRCode(document.getElementById("qrcode"), {
                        text: url,
                        width: 80, height: 80,
                        colorDark : "#000000", colorLight : "#ffffff"
                    });
                    
                    setTimeout(() => {
                        El.loader.style.opacity = 0;
                        setTimeout(() => El.loader.style.display='none', 500);
                        El.actions.classList.add('show');
                    }, 1000);

                } catch(e) {
                    updateStatus(0, "UPLOAD FAILED. CHECK INTERNET.");
                    console.error(e);
                }
            }

            function generateStripCanvas() {
                return new Promise(r => {
                    const ctx = El.canvas.getContext('2d');
                    
                    // Config Dimensions (Tall Strip)
                    const W = CFG.stripW;
                    const photoW = W - 60; // 30px padding each side
                    const photoH = (photoW * 3) / 4;
                    const headerH = 200;
                    const footerH = 150;
                    const gap = 30;
                    const H = headerH + footerH + (photoH * CFG.shots) + (gap * (CFG.shots - 1));

                    El.canvas.width = W;
                    El.canvas.height = H;

                    // Background (Black Paper)
                    ctx.fillStyle = '#0a0a0a';
                    ctx.fillRect(0,0,W,H);
                    
                    // Decorative Lines
                    ctx.strokeStyle = '#333'; ctx.lineWidth = 1;
                    ctx.beginPath(); ctx.moveTo(30, headerH-20); ctx.lineTo(W-30, headerH-20); ctx.stroke();

                    // Header
                    ctx.fillStyle = '#fff'; ctx.textAlign = 'center';
                    ctx.font = 'bold 80px "Space Grotesk"';
                    ctx.fillText('SENA', W/2, 100);
                    ctx.font = '30px "Space Grotesk"';
                    ctx.letterSpacing = '5px';
                    ctx.fillText('SYSTEM OS 3.0', W/2, 150);

                    // Photos
                    let y = headerH;
                    S.photos.forEach(p => {
                        // Crop logic
                        const sRatio = p.width / p.height;
                        const dRatio = photoW / photoH;
                        let sx, sy, sw, sh;
                        if(sRatio > dRatio) { sh=p.height; sw=sh*dRatio; sx=(p.width-sw)/2; sy=0; }
                        else { sw=p.width; sh=sw/dRatio; sx=0; sy=(p.height-sh)/2; }

                        // Draw white border
                        ctx.fillStyle = '#fff';
                        ctx.fillRect((W-photoW)/2 - 5, y - 5, photoW+10, photoH+10);

                        ctx.drawImage(p, sx, sy, sw, sh, (W-photoW)/2, y, photoW, photoH);
                        y += photoH + gap;
                    });

                    // Footer
                    ctx.fillStyle = '#666'; ctx.font = '24px "JetBrains Mono"';
                    const date = new Date().toLocaleDateString('en-GB') + " " + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    ctx.fillText(date, W/2, H - 60);
                    
                    // Barcode decoration
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(W/2 - 50, H - 100, 100, 10);

                    r(El.canvas);
                });
            }

            async function uploadToImgBB(base64) {
                const formData = new FormData();
                formData.append("image", base64.split(',')[1]);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${CFG.apiKey}`, {
                    method: 'POST', body: formData
                });
                const data = await res.json();
                if(data.success) return data.data.url_viewer;
                else throw new Error('API Error');
            }

            function updateStatus(pct, msg) {
                El.progress.style.width = pct + '%';
                El.status.innerText = msg;
            }

            return { init, setFilter, snapSequence };
        })();
    </script>
</body>
</html>
