<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SENA PHOTOBOOTH | DISCO EDITION</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700;900&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. SYSTEM CORE
           ========================================= */
        :root {
            --bg-color: #000;
            --text-main: #E0E0E0;
            --accent: #FFFFFF;  
            --alert: #FF3333; 
            --font-ui: 'DM Sans', sans-serif;
            --font-code: 'VT323', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color);
            height: 100vh; width: 100vw;
            overflow: hidden;
            color: var(--text-main);
            font-family: var(--font-ui);
            display: flex; justify-content: center; align-items: center;
        }

        #monitor {
            width: 100%; height: 100%;
            position: relative;
            background: #050505;
        }

        /* Scanlines & CRT Effect */
        .scanlines {
            position: absolute; inset: 0; pointer-events: none; z-index: 100;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
        }
        .vignette {
            position: absolute; inset: 0; pointer-events: none; z-index: 101;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
        }

        /* =========================================
           2. SCREENS
           ========================================= */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease;
            z-index: 10;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        /* BOOT */
        #screen-boot {
            justify-content: flex-start; padding: 40px;
            font-family: var(--font-code); font-size: 1.2rem; color: #0f0;
            background: #000; z-index: 200;
        }

        /* HOME */
        #screen-home {
            justify-content: center; align-items: center; text-align: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }
        .main-title {
            font-size: 4rem; font-weight: 900; color: #fff;
            line-height: 0.9; letter-spacing: -2px;
            margin-bottom: 50px;
            text-shadow: 0 0 20px rgba(255,255,255,0.4);
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        .btn-coin {
            background: transparent; border: 2px solid #fff;
            padding: 20px 50px; color: #fff;
            font-family: var(--font-code); font-size: 2rem;
            cursor: pointer; position: relative;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
            transition: 0.2s;
        }
        .btn-coin:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .blink-text { animation: blink 1.5s infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

        /* =========================================
           FRAME SELECTION UI
           ========================================= */
        #screen-frames {
            justify-content: center; align-items: center; background: #080808; 
            padding: 40px 20px;
        }

        .frame-list {
            display: flex; gap: 25px; overflow-x: auto; 
            padding: 20px 10px; width: 100%;
            justify-content: center; align-items: center;
            scrollbar-width: none;
        }
        .frame-list::-webkit-scrollbar { display: none; }
        
        .mini-strip {
            width: 140px; height: 380px; flex-shrink: 0;
            display: flex; flex-direction: column;
            padding: 15px 10px; cursor: pointer;
            transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative; border-radius: 2px;
        }
        
        .mini-strip:hover { transform: translateY(-15px) scale(1.05); z-index: 10; box-shadow: 0 20px 30px rgba(0,0,0,0.7); }
        .mini-strip:active { transform: scale(0.98); }

        .strip-header {
            text-align: center; font-weight: 800; font-size: 0.8rem;
            margin-bottom: 10px; line-height: 1.1; white-space: nowrap;
        }
        .strip-header span { display: block; font-weight: 400; font-size: 0.5rem; }

        .strip-photos {
            flex: 1; display: flex; flex-direction: column; gap: 8px;
            justify-content: center; align-items: center;
        }
        .photo-slot {
            width: 100%; aspect-ratio: 4/3;
            background: #444; position: relative; overflow: hidden;
        }
        .photo-slot::after {
            content: 'üì∑'; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            font-size: 1.5rem; opacity: 0.2; filter: grayscale(1);
        }

        .strip-footer {
            text-align: center; font-size: 0.5rem; margin-top: 10px;
            font-family: var(--font-code); opacity: 0.7; white-space: nowrap;
        }

        /* 1. DISCO (SENA THEME - Updated) */
        .mini-strip.disco { 
            /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏µ‡πÄ‡∏ó‡∏≤/‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏ö‡∏ö‡∏î‡∏¥‡∏™‡πÇ‡∏Å‡πâ */
            background: #b0b0b0; 
            color: #fff;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc), 
                              linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
            border: 2px solid #fff;
        }
        .mini-strip.disco .strip-header { 
            color: #fff; text-shadow: 2px 2px 0 #000; font-weight: 900; letter-spacing: 1px;
        }
        .mini-strip.disco .photo-slot { border: 2px solid #fff; background: #333; }
        .mini-strip.disco .strip-footer { color: #000; background: rgba(255,255,255,0.8); padding: 2px; font-weight: bold; }

        /* Other Styles */
        .mini-strip.polaroid { background: #f8f8f8; color: #000; border: 1px solid #ddd; }
        .mini-strip.polaroid .photo-slot { background: #ddd; border: 1px solid #ccc; }

        .mini-strip.love { background: #fff; color: #000; border: 3px solid #ff0000; }
        .mini-strip.love .strip-header { color: #000; }
        .mini-strip.love .photo-slot { border: 3px solid #ff0000; background: #ffebeb; }

        .mini-strip.system { 
            background: #000; color: #0f0; border: 2px solid #0f0; font-family: var(--font-code);
        }
        .mini-strip.system .photo-slot { border: 1px dashed #0f0; background: #001100; }

        .mini-strip.black { background: #1a1a1a; color: #ccc; border: 1px solid #444; }
        .mini-strip.black .photo-slot { border: 1px solid #555; background: #222; }


        /* CAMERA UI */
        #screen-cam { justify-content: space-between; background: #000; }
        .ui-top {
            height: 60px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: #111; border-bottom: 1px solid #333;
            font-family: var(--font-code); font-size: 1.2rem;
        }
        .rec-badge { color: var(--alert); display: flex; align-items: center; gap: 8px; font-weight: bold;}
        .rec-dot { width: 10px; height: 10px; background: var(--alert); border-radius: 50%; }

        .viewport { flex: 1; position: relative; overflow: hidden; background: #050505; }
        video#video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .grid-lines { position: absolute; inset: 0; pointer-events: none; display: none; }
        .grid-lines::before { content:''; position:absolute; left:33.33%; width:33.33%; top:0; bottom:0; border-left:1px solid rgba(255,255,255,0.3); border-right:1px solid rgba(255,255,255,0.3); }
        .grid-lines::after { content:''; position:absolute; top:33.33%; height:33.33%; left:0; right:0; border-top:1px solid rgba(255,255,255,0.3); border-bottom:1px solid rgba(255,255,255,0.3); }
        .grid-lines.show { display: block; }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            font-size: 12rem; font-weight: 800; color: #fff; display: none;
            text-shadow: 4px 4px 0 #000;
        }
        .btn-grid {
            position: absolute; bottom: 20px; right: 20px;
            background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #fff;
            padding: 5px 10px; font-size: 0.8rem; border-radius: 20px;
            cursor: pointer; z-index: 50;
        }

        .ui-controls {
            height: 130px; background: #111; border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: center; gap: 20px;
        }
        .btn-filter {
            width: 70px; height: 70px; background: #222; border: 1px solid #555;
            color: #888; border-radius: 8px; cursor: pointer;
            font-family: var(--font-code); display: flex; align-items: center; justify-content: center;
        }
        .btn-filter.active { background: #fff; color: #000; box-shadow: 0 0 10px #fff; }

        .btn-shutter {
            width: 90px; height: 90px; border: 2px solid #666; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .shutter-inner { width: 76px; height: 76px; background: #fff; border-radius: 50%; transition: 0.1s; }
        .btn-shutter:active .shutter-inner { transform: scale(0.9); background: #ccc; }

        /* RESULT & PRINTER UI */
        #screen-result { 
            justify-content: center; align-items: center; background: #0a0a0a; 
            flex-direction: row; gap: 40px; padding: 20px;
        }
        
        .printer-wrapper { position: relative; }
        .printer-slot {
            width: 340px; height: 65vh;
            border: 1px solid #333; border-top: 4px solid #111;
            background: #000; overflow: hidden; position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.9); border-radius: 4px;
        }
        
        .preview-img {
            width: 100%; height: auto; display: block;
            transform: translateY(105%); box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        
        .printing-active { animation: printSlide 4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes printSlide { 0% { transform: translateY(105%); } 100% { transform: translateY(0); } }

        .result-sidebar {
            display: flex; flex-direction: column; align-items: center; gap: 20px;
            opacity: 0; transition: opacity 1s ease 4s; width: 300px;
        }
        .result-sidebar.show { opacity: 1; }

        .server-log {
            font-family: var(--font-code); color: #0f0; width: 100%;
            background: #111; padding: 10px; border: 1px solid #333;
            font-size: 0.9rem; margin-bottom: 10px; white-space: pre-wrap; line-height: 1.4;
        }
        .loading-bar {
            height: 4px; background: #333; width: 100%; margin-top: 5px;
            position: relative; overflow: hidden;
        }
        .loading-fill {
            position: absolute; left:0; top:0; bottom:0; background: #0f0; width: 0%;
            transition: width 0.2s;
        }

        .qr-container {
            background: #fff; padding: 15px; border-radius: 8px;
            text-align: center; display: none;
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .qr-container.show { display: block; animation: popIn 0.5s ease; }
        @keyframes popIn { 0%{transform:scale(0.8); opacity:0;} 100%{transform:scale(1); opacity:1;} }

        .qr-text {
            color: #000; font-family: var(--font-code); 
            font-size: 1rem; margin-top: 10px; font-weight: bold;
        }

        .action-btns { display: flex; flex-direction: column; gap: 15px; width: 100%; margin-top: 20px; }
        .btn-action {
            padding: 15px 40px; font-family: var(--font-ui); font-weight: 700;
            background: #fff; color: #000; border: none; cursor: pointer; font-size: 1rem;
            width: 100%; border-radius: 4px;
        }
        .btn-action.outline { background: transparent; border: 1px solid #fff; color: #fff; }

        #flash { position: fixed; inset: 0; background: #fff; z-index: 999; opacity: 0; pointer-events: none; }
        .do-flash { animation: flashAnim 0.2s linear; }
        @keyframes flashAnim { 0%,100%{opacity:0;} 50%{opacity:1;} }
        
        @media (max-width: 800px) {
            #screen-result { flex-direction: column; gap: 20px; padding-top: 60px;}
            .printer-slot { height: 50vh; width: 80vw; }
            .result-sidebar { width: 80vw; transition-delay: 3s; }
            .action-btns { flex-direction: row; }
            .mini-strip { width: 110px; height: 300px; }
        }
    </style>
</head>
<body>

    <div id="monitor">
        <div class="scanlines"></div>
        <div class="vignette"></div>

        <div id="screen-boot" class="screen active">
            <div id="boot-log"></div>
            <span class="blink-text">_</span>
        </div>

        <div id="screen-home" class="screen">
            <div class="main-title">SENA<br>PHOTOBOOTH</div>
            <button class="btn-coin" onclick="OS.start()">
                <span class="blink-text">INSERT COIN</span>
            </button>
            <p style="margin-top:20px; font-family:var(--font-code); color:#666;">CREDIT 0/1</p>
        </div>

        <div id="screen-frames" class="screen">
            <h2 style="font-family:var(--font-code); color:#fff; margin-bottom:10px; text-align:center; width:100%;">SELECT YOUR STRIP</h2>
            
            <div class="frame-list">
                
                <div class="mini-strip disco" onclick="OS.selectFrame('disco')">
                    <div class="strip-header">ü™© SENA ü™©<br><span>DISCO BOOTH</span></div>
                    <div class="strip-photos">
                        <div class="photo-slot"></div>
                        <div class="photo-slot"></div>
                        <div class="photo-slot"></div>
                    </div>
                    <div class="strip-footer">DD/MM/YY ‚Ä¢ MEMORIES</div>
                </div>

                <div class="mini-strip polaroid" onclick="OS.selectFrame('polaroid')">
                    <div class="strip-header">SENA<br><span>PHOTOBOOTH</span></div>
                    <div class="strip-photos">
                        <div class="photo-slot"></div>
                        <div class="photo-slot"></div>
                        <div class="photo-slot"></div>
                    </div>
                    <div class="strip-footer">DD/MM/YY ‚Ä¢ MEMORIES</div>
                </div>

                <div class="mini-strip love" onclick="OS.selectFrame('love')">
                    <div class="strip-header">I <span style="color:red; display:inline; font-size:1rem;">‚ô•</span> SENA</div>
                    <div class="strip-photos">
                        <div class="photo-slot"></div>
                        <div class="photo-slot"></div>
                        <div class="photo-slot"></div>
                    </div>
                    <div class="strip-footer">DD/MM/YY ‚Ä¢ FOREVER YOUNG</div>
                </div>

                <div class="mini-strip system" onclick="OS.selectFrame('system')">
                    <div class="strip-header">SYS.LOG: CAPTURED</div>
                    <div class="strip-photos">
                        <div class="photo-slot"></div>
                        <div class="photo-slot"></div>
                        <div class="photo-slot"></div>
                    </div>
                    <div class="strip-footer">> END_PROCESS</div>
                </div>

                 <div class="mini-strip black" onclick="OS.selectFrame('black')">
                    <div class="strip-header">SENA<br><span>PHOTOBOOTH</span></div>
                    <div class="strip-photos">
                        <div class="photo-slot"></div>
                        <div class="photo-slot"></div>
                        <div class="photo-slot"></div>
                    </div>
                    <div class="strip-footer">DD/MM/YY ‚Ä¢ KEEP SMILING</div>
                </div>

            </div>
        </div>

        <div id="screen-cam" class="screen">
            <div class="ui-top">
                <div class="rec-badge"><div class="rec-dot"></div> REC</div>
                <div id="clock">00:00</div>
            </div>
            
            <div class="viewport">
                <video id="video-feed" autoplay playsinline muted></video>
                <div class="grid-lines" id="grid"></div>
                <div id="countdown">3</div>
                <button class="btn-grid" onclick="OS.toggleGrid()"># GRID</button>
            </div>

            <div class="ui-controls">
                <button class="btn-filter active" onclick="OS.filter('color', this)">CLR</button>
                <button class="btn-filter" onclick="OS.filter('bw', this)">B/W</button>
                <button class="btn-filter" onclick="OS.filter('film', this)">FILM</button>
                <div class="btn-shutter" onclick="OS.snap()">
                    <div class="shutter-inner"></div>
                </div>
                <div style="width:70px"></div>
            </div>
        </div>

        <div id="screen-result" class="screen">
            <div class="printer-wrapper">
                <div class="printer-slot">
                    <img id="final-img" class="preview-img" alt="Print">
                </div>
            </div>

            <div class="result-sidebar" id="res-sidebar">
                
                <div class="server-log" id="server-status">
                    <div id="log-text">> STANDBY...</div>
                    <div class="loading-bar"><div class="loading-fill" id="load-fill"></div></div>
                </div>

                <div class="qr-container" id="qr-box">
                    <div id="qrcode"></div>
                    <div class="qr-text" id="qr-status-text">SCAN TO DOWNLOAD</div>
                </div>
                
                <div class="action-btns">
                    <button class="btn-action" onclick="OS.download()">SAVE TO DEVICE</button>
                    <button class="btn-action outline" onclick="location.reload()">RESTART</button>
                </div>
            </div>
        </div>
    </div>

    <div id="flash"></div>
    <canvas id="hidden-canvas" style="display:none"></canvas>

    <script>
        const OS = (function() {
            
            // ============================================
            // ‚ö†Ô∏è SETUP YOUR API KEY HERE FOR REAL QR CODE
            // Get free key at: https://api.imgbb.com/
            // ============================================
            const API_KEY = 'ffc90ad0bc5c7e0c056b68ef7430304a'; 
            
            const C = {
                w: 1280, h: 720,
                stripW: 600,
                shots: 3, 
                // Updated quotes for footer
                quotes: ["MEMORIES", "GOOD VIBES", "FRIENDSHIP", "FOREVER YOUNG", "BEST TIMES"]
            };

            let s = { 
                filter: 'color', 
                frame: 'disco', // Default selection
                photos: [], 
                stream: null, 
                processing: false 
            };

            const D = {
                screens: {
                    boot: document.getElementById('screen-boot'),
                    home: document.getElementById('screen-home'),
                    frames: document.getElementById('screen-frames'),
                    cam: document.getElementById('screen-cam'),
                    res: document.getElementById('screen-result')
                },
                video: document.getElementById('video-feed'),
                canvas: document.getElementById('hidden-canvas'),
                count: document.getElementById('countdown'),
                flash: document.getElementById('flash'),
                final: document.getElementById('final-img'),
                grid: document.getElementById('grid'),
                log: document.getElementById('boot-log'),
                clock: document.getElementById('clock'),
                sidebar: document.getElementById('res-sidebar'),
                serverStatus: document.getElementById('server-status'),
                logText: document.getElementById('log-text'),
                loadFill: document.getElementById('load-fill'),
                qrBox: document.getElementById('qr-box'),
                qrStatus: document.getElementById('qr-status-text')
            };

            const Aud = {
                ctx: null,
                init: function() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
                play: function(type) {
                    this.init();
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    if(type === 'coin') { o.frequency.value = 1200; g.gain.value = 0.1; o.start(); o.stop(this.ctx.currentTime+0.2); }
                    else if(type === 'beep') { o.type='square'; o.frequency.value = 800; g.gain.value = 0.05; o.start(); o.stop(this.ctx.currentTime+0.1); }
                    else if(type === 'shutter') { o.type='sawtooth'; o.frequency.value = 100; g.gain.value = 0.1; o.start(); o.stop(this.ctx.currentTime+0.1); }
                    else if(type === 'print') {
                        o.type='sawtooth'; o.frequency.value = 60; g.gain.value = 0.05; 
                        o.start(); o.stop(this.ctx.currentTime + 3.5);
                        const o2 = this.ctx.createOscillator(); const g2 = this.ctx.createGain();
                        o2.connect(g2); g2.connect(this.ctx.destination);
                        o2.type='sine'; o2.frequency.value = 1500; g2.gain.value=0.01;
                        o2.start(); o2.stop(this.ctx.currentTime + 3.5);
                    }
                }
            };

            window.onload = async () => {
                const logs = ["SENA OS v2.5", "NETWORKING INIT...", "CHECKING CLOUD...", "SYSTEM READY."];
                for(let l of logs) { D.log.innerHTML += l + "<br>"; await new Promise(r => setTimeout(r, 400)); }
                setTimeout(() => { D.screens.boot.classList.remove('active'); D.screens.home.classList.add('active'); }, 800);
            };

            setInterval(() => {
                const d = new Date();
                D.clock.innerText = d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
            }, 1000);

            async function start() {
                Aud.play('coin');
                D.screens.home.classList.remove('active');
                D.screens.frames.classList.add('active');
            }

            async function selectFrame(type) {
                s.frame = type;
                Aud.play('beep');
                try {
                    s.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: C.w, height: C.h } });
                    D.video.srcObject = s.stream;
                    D.screens.frames.classList.remove('active');
                    D.screens.cam.classList.add('active');
                    // Auto set filter for disco
                    if(type === 'disco') filter('bw', document.querySelectorAll('.btn-filter')[1]);
                    else filter('color', document.querySelectorAll('.btn-filter')[0]);

                } catch(e) { alert("Camera Access Required"); }
            }

            function toggleGrid() { D.grid.classList.toggle('show'); }
            function filter(mode, btn) {
                s.filter = mode;
                document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                if(btn) btn.classList.add('active');
                let css = 'none';
                if(mode==='bw') css = 'grayscale(100%) contrast(1.1)';
                if(mode==='film') css = 'sepia(0.3) contrast(1.1) saturate(0.8)';
                D.video.style.filter = css;
                Aud.play('beep');
            }

            async function snap() {
                if(s.processing) return;
                s.processing = true; s.photos = [];
                for(let i=0; i<C.shots; i++) {
                    await countdown(3);
                    await capture();
                    await new Promise(r => setTimeout(r, 800));
                }
                process();
            }

            function countdown(n) {
                return new Promise(r => {
                    let c = n; D.count.style.display = 'block'; D.count.innerText = c;
                    const t = setInterval(() => {
                        Aud.play('beep'); c--;
                        if(c>0) D.count.innerText = c;
                        else { clearInterval(t); D.count.style.display = 'none'; r(); }
                    }, 1000);
                });
            }

            function capture() {
                return new Promise(r => {
                    Aud.play('shutter');
                    D.flash.classList.add('do-flash');
                    setTimeout(() => D.flash.classList.remove('do-flash'), 200);
                    const cvs = document.createElement('canvas');
                    cvs.width = D.video.videoWidth; cvs.height = D.video.videoHeight;
                    const ctx = cvs.getContext('2d');
                    ctx.translate(cvs.width, 0); ctx.scale(-1, 1);
                    ctx.drawImage(D.video, 0, 0);
                    
                    if(s.filter !== 'color') {
                        const id = ctx.getImageData(0,0,cvs.width,cvs.height);
                        const d = id.data;
                        for(let i=0; i<d.length; i+=4) {
                            const R=d[i], G=d[i+1], B=d[i+2];
                            if(s.filter === 'bw') {
                                const v = 0.299*R + 0.587*G + 0.114*B;
                                d[i]=d[i+1]=d[i+2]=v;
                            } else if(s.filter === 'film') {
                                d[i] = R*0.393+G*0.769+B*0.189; d[i+1] = R*0.349+G*0.686+B*0.168; d[i+2] = R*0.272+G*0.534+B*0.131;
                                const n = (Math.random()-0.5)*25; d[i]+=n; d[i+1]+=n; d[i+2]+=n;
                            }
                        }
                        ctx.putImageData(id, 0, 0);
                    }
                    s.photos.push(cvs);
                    setTimeout(r, 200);
                });
            }

            // NEW: Function to draw the Silver Disco Grid
            function drawDiscoPattern(ctx, w, h) {
                const cols = 12; 
                const tileSize = w / cols;
                const rows = Math.ceil(h / tileSize);

                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        // Random Silver/Gray shades
                        const val = Math.floor(Math.random() * 80) + 160; // range 160-240 (light gray)
                        ctx.fillStyle = `rgb(${val}, ${val}, ${val})`;
                        ctx.fillRect(c * tileSize, r * tileSize, tileSize, tileSize);
                        
                        // Add border to tile
                        ctx.strokeStyle = '#999';
                        ctx.lineWidth = 1;
                        ctx.strokeRect(c * tileSize, r * tileSize, tileSize, tileSize);

                        // Random "Shine" on some tiles
                        if(Math.random() > 0.8) {
                            ctx.fillStyle = 'rgba(255,255,255,0.6)';
                            ctx.beginPath();
                            ctx.arc(c*tileSize + tileSize*0.2, r*tileSize + tileSize*0.2, 3, 0, Math.PI*2);
                            ctx.fill();
                        }
                    }
                }
                
                // Add star sparkles
                for(let i=0; i<10; i++) {
                    const cx = Math.random() * w; const cy = Math.random() * h;
                    ctx.fillStyle = '#fff';
                    ctx.font = "20px Serif";
                    ctx.fillText("‚ú®", cx, cy);
                }
            }

            function process() {
                if(s.stream) s.stream.getTracks().forEach(t=>t.stop());

                const f = s.frame;
                let stripW = C.stripW; 
                let photoW = 540, photoH = (photoW*3)/4;
                let gap = 25, head = 180, foot = 100; // Increased Header height for Disco
                let H = head + (photoH*C.shots) + (gap*(C.shots-1)) + foot;

                D.canvas.width = stripW; D.canvas.height = H;
                const ctx = D.canvas.getContext('2d');

                // 1. BACKGROUND
                if(f === 'disco') drawDiscoPattern(ctx, stripW, H);
                else if(f === 'black') { ctx.fillStyle = '#111'; ctx.fillRect(0,0,stripW,H); }
                else if(f === 'system') { ctx.fillStyle = '#000'; ctx.fillRect(0,0,stripW,H); }
                else { ctx.fillStyle = '#f8f8f8'; ctx.fillRect(0,0,stripW,H); }

                // 2. HEADER
                ctx.textAlign = 'center';
                if(f === 'love') {
                    ctx.fillStyle = '#000'; ctx.font = 'bold 60px "DM Sans"'; ctx.fillText('I', stripW/2 - 130, 100);
                    ctx.fillStyle = '#FF0000'; ctx.font = '70px "DM Sans"'; ctx.fillText('‚ô•', stripW/2 - 50, 100);
                    ctx.fillStyle = '#000'; ctx.font = 'bold 60px "DM Sans"'; ctx.fillText('SENA', stripW/2 + 100, 100);
                } 
                else if (f === 'disco') {
                    // DISCO HEADER TEXT (Updated Style)
                    ctx.shadowColor = "rgba(0,0,0,0.5)"; ctx.shadowBlur = 4; ctx.shadowOffsetX = 3; ctx.shadowOffsetY = 3;
                    
                    // "SENA"
                    ctx.fillStyle = '#fff'; 
                    ctx.font = '900 70px "DM Sans"'; 
                    ctx.fillText('ü™© SENA ü™©', stripW/2, 90);
                    
                    // "DISCO BOOTH"
                    ctx.font = '700 35px "DM Sans"'; 
                    ctx.letterSpacing = "2px";
                    ctx.fillText('DISCO BOOTH', stripW/2, 140);
                    
                    ctx.shadowBlur = 0; ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0; // Reset Shadow
                } 
                else if(f === 'system') {
                    ctx.fillStyle = '#0f0'; ctx.font = '40px "VT323"'; ctx.fillText('SYS.LOG: CAPTURED', stripW/2, 80);
                    ctx.strokeStyle = '#0f0'; ctx.lineWidth = 2; ctx.strokeRect(10,10,stripW-20,H-20);
                } else {
                    ctx.fillStyle = (f==='black') ? '#fff' : '#000';
                    ctx.font = 'bold 40px "DM Sans"'; ctx.fillText('SENA', stripW/2, 80);
                    ctx.font = '700 24px "DM Sans"'; ctx.fillText('PHOTOBOOTH', stripW/2, 120);
                }

                // 3. PHOTOS
                let y = head;
                s.photos.forEach(p => {
                    const sR = p.width/p.height; const dR=4/3;
                    let sx, sy, sw, sh;
                    if(sR > dR) { sh=p.height; sw=sh*dR; sx=(p.width-sw)/2; sy=0; }
                    else { sw=p.width; sh=sw/dR; sx=0; sy=(p.height-sh)/2; }
                    
                    if(f === 'system') { ctx.strokeStyle = '#0f0'; ctx.lineWidth=2; ctx.strokeRect((stripW-photoW)/2 - 5, y - 5, photoW + 10, photoH + 10); }
                    else if(f === 'disco') { 
                        // White Border for Disco Photos
                        ctx.fillStyle = '#fff'; 
                        ctx.shadowColor = "rgba(0,0,0,0.3)"; ctx.shadowBlur=10;
                        ctx.fillRect((stripW-photoW)/2 - 10, y - 10, photoW + 20, photoH + 20); 
                        ctx.shadowBlur=0;
                    }
                    else if(f === 'love') { ctx.strokeStyle = '#FF0000'; ctx.lineWidth=4; ctx.strokeRect((stripW-photoW)/2, y, photoW, photoH); }

                    ctx.drawImage(p, sx, sy, sw, sh, (stripW-photoW)/2, y, photoW, photoH);
                    y += photoH + gap;
                });

                // 4. FOOTER
                const quote = C.quotes[Math.floor(Math.random()*C.quotes.length)];
                ctx.font = '24px "VT323"'; ctx.textAlign = 'center'; 
                
                const date = new Date().toLocaleDateString('en-GB'); // DD/MM/YYYY

                if(f === 'system') {
                    ctx.fillStyle = '#0f0'; 
                    ctx.fillText(`> ${date} // END_PROCESS`, stripW/2, H - 40);
                }
                else if(f === 'disco') {
                     // Disco Footer Style
                    ctx.fillStyle = '#fff';
                    ctx.shadowColor="black"; ctx.shadowBlur=4;
                    ctx.font = '700 20px "DM Sans"';
                    ctx.fillText(`${date}  ‚Ä¢  MEMORIES`, stripW/2, H - 40);
                    ctx.shadowBlur=0;
                }
                else {
                    ctx.fillStyle = (f==='black') ? '#888' : '#666';
                    ctx.fillText(`${date}  ‚Ä¢  ${quote}`, stripW/2, H - 40);
                }

                // --- FINAL RENDER & ANIMATION ---
                const finalDataUrl = D.canvas.toDataURL('image/jpeg', 0.9);
                D.final.src = finalDataUrl;
                
                D.screens.cam.classList.remove('active');
                D.screens.res.classList.add('active');
                
                Aud.play('print');
                D.final.classList.add('printing-active');
                
                setTimeout(() => { 
                    D.sidebar.classList.add('show'); 
                    handleUpload(finalDataUrl); 
                }, 3500);
            }

            async function handleUpload(base64Image) {
                let p = 0;
                D.logText.innerText = "> UPLOADING TO CLOUD...";
                const int = setInterval(() => {
                    p += Math.random() * 10;
                    if(p > 90) clearInterval(int);
                    else D.loadFill.style.width = p + "%";
                }, 200);

                // --- CHECK API KEY ---
                if (!API_KEY || API_KEY.length < 10) {
                    setTimeout(() => {
                        clearInterval(int);
                        D.loadFill.style.width = "100%";
                        D.logText.innerText = "> NO API KEY\n> GENERATING LOCAL QR...";
                        D.logText.style.color = "yellow";
                        generateQR(window.location.href);
                        D.qrStatus.innerText = "DEMO MODE (LOCAL)";
                        setTimeout(() => { D.serverStatus.style.display = 'block'; D.qrBox.classList.add('show'); }, 500);
                    }, 2000);
                } else {
                    try {
                        const cleanBase64 = base64Image.split(',')[1];
                        const formData = new FormData();
                        formData.append("image", cleanBase64);

                        const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
                            method: 'POST', body: formData
                        });
                        const data = await res.json();
                        clearInterval(int); D.loadFill.style.width = "100%";

                        if(data.success) {
                            D.logText.innerText = "> UPLOAD SUCCESS!\n> ID: " + data.data.id;
                            generateQR(data.data.url);
                            setTimeout(() => { D.serverStatus.style.display = 'none'; D.qrBox.classList.add('show'); }, 500);
                        } else { throw new Error('Upload Failed'); }
                    } catch(e) {
                        D.logText.innerText = "> UPLOAD FAILED"; D.logText.style.color = "red";
                        generateQR(window.location.href); D.qrBox.classList.add('show');
                    }
                }
            }

            function generateQR(url) {
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), {
                    text: url, width: 140, height: 140,
                    colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.L
                });
            }

            function download() {
                const a = document.createElement('a');
                a.download = `SENA_DISCO_${Date.now()}.jpg`;
                a.href = D.canvas.toDataURL('image/jpeg', 1.0);
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }

            return { start, selectFrame, toggleGrid, filter, snap, download };
        })();
    </script>
</body>
</html>
