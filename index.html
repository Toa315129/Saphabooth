<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SENA PHOTOBOOTH | PRO EDITION</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700;800&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. SYSTEM CORE & IPAD OPTIMIZATION
           ========================================= */
        :root {
            --bg-color: #000;
            --text-main: #E0E0E0;
            --accent: #00ff41;  /* Hacker Green Accent */
            --alert: #FF3333; 
            --font-ui: 'DM Sans', sans-serif;
            --font-code: 'VT323', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color);
            height: 100vh; height: 100dvh; /* Dynamic Height for Mobile/iPad */
            width: 100vw;
            overflow: hidden;
            color: var(--text-main);
            font-family: var(--font-ui);
            display: flex; justify-content: center; align-items: center;
            touch-action: none; /* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÉ‡∏ô iPad */
        }

        #monitor {
            width: 100%; height: 100%;
            position: relative;
            background: #050505;
            display: flex; flex-direction: column;
        }

        /* Scanlines & CRT Effect */
        .scanlines {
            position: absolute; inset: 0; pointer-events: none; z-index: 900;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px;
            opacity: 0.6;
        }
        .vignette {
            position: absolute; inset: 0; pointer-events: none; z-index: 901;
            background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.6) 100%);
        }

        /* =========================================
           2. SCREENS & TRANSITIONS
           ========================================= */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease;
            z-index: 10;
            background: #000;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        /* BOOT */
        #screen-boot {
            justify-content: flex-start; padding: 40px;
            font-family: var(--font-code); font-size: 1.5rem; color: var(--accent);
            z-index: 1000;
        }

        /* HOME */
        #screen-home {
            justify-content: center; align-items: center; text-align: center;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
        }
        .main-title {
            font-size: clamp(3rem, 8vw, 6rem); /* Responsive Font */
            font-weight: 800; color: #fff;
            line-height: 0.9; letter-spacing: -2px;
            margin-bottom: 4vh;
            text-shadow: 0 0 20px rgba(255,255,255,0.4);
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        .btn-coin {
            background: transparent; border: 2px solid #fff;
            padding: 2vh 4vw; color: #fff;
            font-family: var(--font-code); font-size: 2rem;
            cursor: pointer; position: relative;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
            transition: 0.2s; border-radius: 4px;
        }
        .btn-coin:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .blink-text { animation: blink 1.5s infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

        /* =========================================
           FRAME SELECTION UI
           ========================================= */
        #screen-frames {
            justify-content: center; align-items: center; background: #080808; 
            padding: 20px;
        }
        .frame-list {
            display: flex; gap: 30px;
            overflow-x: auto; 
            padding: 40px 20px;
            width: 100%;
            justify-content: flex-start; /* iPad scroll fix */
            align-items: center;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .frame-list::-webkit-scrollbar { display: none; }
        
        .mini-strip {
            width: 160px; height: 420px; 
            flex-shrink: 0;
            display: flex; flex-direction: column;
            padding: 15px 10px; cursor: pointer;
            transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            position: relative; border-radius: 2px;
        }
        .mini-strip:hover, .mini-strip:active { transform: translateY(-15px) scale(1.05); z-index: 10; box-shadow: 0 20px 30px rgba(0,0,0,0.7); }
        
        /* Styles Reuse */
        .strip-header { text-align: center; font-weight: 800; font-size: 0.9rem; margin-bottom: 10px; line-height: 1.1; white-space: nowrap; }
        .strip-header span { display: block; font-weight: 400; font-size: 0.6rem; }
        .strip-photos { flex: 1; display: flex; flex-direction: column; gap: 8px; justify-content: center; align-items: center; }
        .photo-slot { width: 100%; aspect-ratio: 4/3; background: #444; position: relative; overflow: hidden; }
        .photo-slot::after { content: 'üì∑'; position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size: 1.5rem; opacity: 0.2; }
        .strip-footer { text-align: center; font-size: 0.6rem; margin-top: 10px; font-family: var(--font-code); opacity: 0.7; white-space: nowrap; }

        .mini-strip.polaroid { background: #f8f8f8; color: #000; border: 1px solid #ddd; }
        .mini-strip.disco { background: #111; color: #fff; border: 1px solid #333; background-image: radial-gradient(white 15%, transparent 16%), radial-gradient(white 15%, transparent 16%); background-size: 10px 10px; background-position: 0 0, 5px 5px; }
        .mini-strip.love { background: #fff; color: #000; border: 3px solid #ff0000; }
        .mini-strip.system { background: #000; color: #0f0; border: 2px solid #0f0; font-family: var(--font-code); }
        .mini-strip.black { background: #1a1a1a; color: #ccc; border: 1px solid #444; }

        /* =========================================
           CAMERA UI (ENHANCED)
           ========================================= */
        #screen-cam { justify-content: space-between; background: #000; }
        
        .ui-top {
            height: 60px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: #111; border-bottom: 1px solid #333;
            font-family: var(--font-code); font-size: 1.2rem;
            z-index: 20;
        }
        .rec-badge { color: var(--alert); display: flex; align-items: center; gap: 8px; font-weight: bold;}
        .rec-dot { width: 10px; height: 10px; background: var(--alert); border-radius: 50%; }

        /* Tools Sidebar */
        .cam-sidebar {
            position: absolute; top: 70px; right: 10px; bottom: 140px;
            width: 60px; display: flex; flex-direction: column; gap: 15px;
            z-index: 50; pointer-events: none; /* Let clicks pass through if needed, but buttons need pointer-events:auto */
        }
        .tool-btn {
            width: 50px; height: 50px; background: rgba(0,0,0,0.6); 
            border: 1px solid #fff; border-radius: 50%; color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; pointer-events: auto;
            backdrop-filter: blur(5px);
        }
        .tool-btn.active { background: #fff; color: #000; }

        .viewport { flex: 1; position: relative; overflow: hidden; background: #050505; display: flex; justify-content: center; align-items: center;}
        video#video-feed { 
            width: 100%; height: 100%; 
            object-fit: cover; 
            transform: scaleX(-1); /* Default Mirror */
            transition: filter 0.3s;
        }
        
        /* Filters */
        .filter-beauty { filter: contrast(1.05) brightness(1.1) saturate(1.1) blur(0.5px); }
        .filter-bw { filter: grayscale(100%) contrast(1.2); }
        .filter-film { filter: sepia(0.3) contrast(1.1) saturate(0.8); }
        .filter-glitch { animation: glitchAnim 0.2s infinite; }
        @keyframes glitchAnim { 
            0% { transform: translate(0) scaleX(-1); } 
            20% { transform: translate(-2px, 2px) scaleX(-1); } 
            40% { transform: translate(-2px, -2px) scaleX(-1); } 
            60% { transform: translate(2px, 2px) scaleX(-1); } 
            80% { transform: translate(2px, -2px) scaleX(-1); } 
            100% { transform: translate(0) scaleX(-1); } 
        }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            font-size: 15rem; font-weight: 800; color: #fff; display: none;
            text-shadow: 4px 4px 0 #000; z-index: 100;
        }

        .ui-controls {
            height: 140px; background: #111; border-top: 1px solid #333;
            display: flex; align-items: center; justify-content: center; gap: 15px;
            padding-bottom: 10px; z-index: 20;
        }
        .filter-scroller {
            display: flex; gap: 10px; overflow-x: auto; padding: 0 10px;
            max-width: 40%; scrollbar-width: none;
        }
        .btn-filter {
            min-width: 60px; height: 60px; background: #222; border: 1px solid #555;
            color: #888; border-radius: 8px; cursor: pointer;
            font-family: var(--font-code); display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
        }
        .btn-filter.active { background: #fff; color: #000; box-shadow: 0 0 10px #fff; }

        .btn-shutter {
            width: 80px; height: 80px; border: 4px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            flex-shrink: 0; margin: 0 20px;
        }
        .shutter-inner { width: 68px; height: 68px; background: #fff; border-radius: 50%; transition: 0.1s; }
        .btn-shutter:active .shutter-inner { transform: scale(0.9); background: #ccc; }

        /* =========================================
           DECORATION / EDIT SCREEN (NEW)
           ========================================= */
        #screen-edit {
            background: #111; flex-direction: column;
        }
        .edit-area {
            flex: 1; display: flex; justify-content: center; align-items: center;
            position: relative; overflow: hidden; background: #222;
        }
        #edit-canvas-container {
            position: relative; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }
        .edit-toolbar {
            height: 100px; background: #000; display: flex; align-items: center; justify-content: center; gap: 20px;
            border-top: 1px solid #333;
        }
        .sticker-drawer {
            position: absolute; bottom: 100px; left: 0; right: 0; height: 120px;
            background: rgba(0,0,0,0.9); display: none;
            overflow-x: auto; align-items: center; padding: 0 20px; gap: 20px;
            border-top: 1px solid #444; z-index: 200;
        }
        .sticker-drawer.open { display: flex; }
        .sticker-item { font-size: 3rem; cursor: pointer; transition: 0.2s; }
        .sticker-item:active { transform: scale(1.2); }
        
        .drawing-layer { position: absolute; inset: 0; cursor: crosshair; touch-action: none; }
        .placed-sticker { position: absolute; font-size: 4rem; user-select: none; cursor: grab; }

        /* =========================================
           RESULT & PRINTER UI
           ========================================= */
        #screen-result { 
            justify-content: center; align-items: center; background: #0a0a0a; 
            flex-direction: row; gap: 4vw; padding: 20px;
        }
        
        .printer-wrapper { position: relative; height: 70vh; aspect-ratio: 160/420; }
        .printer-slot {
            width: 100%; height: 100%;
            border: 1px solid #333; border-top: 4px solid #111;
            background: #000; overflow: hidden; position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.9); border-radius: 4px;
        }
        .preview-img { width: 100%; height: auto; display: block; transform: translateY(105%); box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .printing-active { animation: printSlide 4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes printSlide { 0% { transform: translateY(105%); } 100% { transform: translateY(0); } }

        .result-sidebar {
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            opacity: 0; transition: opacity 1s ease 4s; width: 320px;
        }
        .result-sidebar.show { opacity: 1; }

        .server-log {
            font-family: var(--font-code); color: var(--accent); width: 100%;
            background: #111; padding: 10px; border: 1px solid #333;
            font-size: 0.9rem; margin-bottom: 5px;
            white-space: pre-wrap; line-height: 1.4;
        }
        .loading-bar { height: 4px; background: #333; width: 100%; margin-top: 5px; position: relative; overflow: hidden; }
        .loading-fill { position: absolute; left:0; top:0; bottom:0; background: var(--accent); width: 0%; transition: width 0.2s; }

        .qr-container { background: #fff; padding: 10px; border-radius: 8px; text-align: center; display: none; }
        .qr-container.show { display: block; animation: popIn 0.5s ease; }
        .email-box { width: 100%; display: flex; gap: 5px; margin-top: 5px; }
        .email-input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 8px; font-family: var(--font-ui); border-radius: 4px;}
        
        .action-btns { display: flex; flex-direction: column; gap: 10px; width: 100%; margin-top: 10px; }
        .btn-action {
            padding: 12px; font-family: var(--font-ui); font-weight: 700;
            background: #fff; color: #000; border: none; cursor: pointer; font-size: 1rem;
            width: 100%; border-radius: 4px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-action.outline { background: transparent; border: 1px solid #fff; color: #fff; }
        .print-control { display: flex; justify-content: space-between; align-items: center; width: 100%; background: #222; padding: 5px 15px; border-radius: 4px; margin-top: 5px;}

        #flash { position: fixed; inset: 0; background: #fff; z-index: 9999; opacity: 0; pointer-events: none; }
        .do-flash { animation: flashAnim 0.2s linear; }
        @keyframes flashAnim { 0%,100%{opacity:0;} 50%{opacity:1;} }
        
        /* iPad / Mobile Responsiveness */
        @media (max-width: 1024px) {
            #screen-result { flex-direction: column; padding-top: 40px; justify-content: flex-start; overflow-y: auto;}
            .printer-wrapper { height: 50vh; margin-bottom: 20px; flex-shrink: 0; }
            .result-sidebar { width: 90%; transition-delay: 2s; padding-bottom: 40px; }
            .action-btns { flex-direction: row; flex-wrap: wrap; }
            .btn-action { flex: 1; min-width: 140px; }
            .cam-sidebar { right: 20px; top: 80px; }
            .tool-btn { width: 60px; height: 60px; font-size: 1.4rem; }
        }
    </style>
</head>
<body>

    <div id="monitor">
        <div class="scanlines"></div>
        <div class="vignette"></div>

        <div id="screen-boot" class="screen active">
            <div id="boot-log"></div>
            <span class="blink-text">_</span>
        </div>

        <div id="screen-home" class="screen">
            <button style="position:absolute; top:20px; right:20px; background:none; border:none; color:#333; font-size:2rem;" onclick="toggleFullscreen()">‚õ∂</button>
            <div class="main-title">SENA<br>PHOTOBOOTH</div>
            <button class="btn-coin" onclick="OS.start()">
                <span class="blink-text">TOUCH TO START</span>
            </button>
            <p style="margin-top:20px; font-family:var(--font-code); color:#666;">PRO EDITION v3.0</p>
        </div>

        <div id="screen-frames" class="screen">
            <h2 style="font-family:var(--font-code); color:#fff; margin-bottom:10px; text-align:center;">SELECT THEME</h2>
            
            <div class="frame-list">
                <div class="mini-strip polaroid" onclick="OS.selectFrame('polaroid')">
                    <div class="strip-header">SENA<br><span>PHOTOBOOTH</span></div>
                    <div class="strip-photos"><div class="photo-slot"></div><div class="photo-slot"></div><div class="photo-slot"></div></div>
                    <div class="strip-footer">CLEAN WHITE</div>
                </div>
                <div class="mini-strip disco" onclick="OS.selectFrame('disco')">
                    <div class="strip-header">ü™© SENA ü™©<br><span>DISCO</span></div>
                    <div class="strip-photos"><div class="photo-slot"></div><div class="photo-slot"></div><div class="photo-slot"></div></div>
                    <div class="strip-footer">NIGHT VIBE</div>
                </div>
                <div class="mini-strip love" onclick="OS.selectFrame('love')">
                    <div class="strip-header">I ‚ô• SENA</div>
                    <div class="strip-photos"><div class="photo-slot"></div><div class="photo-slot"></div><div class="photo-slot"></div></div>
                    <div class="strip-footer">LOVER</div>
                </div>
                <div class="mini-strip system" onclick="OS.selectFrame('system')">
                    <div class="strip-header">SYS.LOG</div>
                    <div class="strip-photos"><div class="photo-slot"></div><div class="photo-slot"></div><div class="photo-slot"></div></div>
                    <div class="strip-footer">CYBERPUNK</div>
                </div>
                <div class="mini-strip black" onclick="OS.selectFrame('black')">
                    <div class="strip-header">SENA<br><span>CLASSIC</span></div>
                    <div class="strip-photos"><div class="photo-slot"></div><div class="photo-slot"></div><div class="photo-slot"></div></div>
                    <div class="strip-footer">DARK MODE</div>
                </div>
            </div>
            
            <button class="btn-action outline" style="width:200px; margin:0 auto;" onclick="location.reload()">‚Üê BACK</button>
        </div>

        <div id="screen-cam" class="screen">
            <div class="ui-top">
                <div class="rec-badge"><div class="rec-dot"></div> REC</div>
                <div id="clock">00:00</div>
            </div>
            
            <div class="viewport">
                <video id="video-feed" autoplay playsinline muted></video>
                <div id="countdown">3</div>
                
                <div class="cam-sidebar">
                    <div class="tool-btn" onclick="OS.toggleCamFlip()">‚Üª</div>
                    <div class="tool-btn" onclick="OS.toggleTimer()" id="btn-timer">3s</div>
                    <div class="tool-btn" onclick="OS.toggleFlash()">‚ö°</div>
                    <div class="tool-btn" onclick="OS.toggleMirror()">‚Üî</div>
                    <div class="tool-btn" onclick="OS.toggleGrid()">#</div>
                </div>
            </div>

            <div class="ui-controls">
                <div class="filter-scroller">
                    <button class="btn-filter active" onclick="OS.filter('normal', this)">NORM</button>
                    <button class="btn-filter" onclick="OS.filter('beauty', this)">SOFT</button>
                    <button class="btn-filter" onclick="OS.filter('bw', this)">B/W</button>
                    <button class="btn-filter" onclick="OS.filter('film', this)">FILM</button>
                    <button class="btn-filter" onclick="OS.filter('glitch', this)">GLITCH</button>
                </div>

                <div class="btn-shutter" onclick="OS.snap()">
                    <div class="shutter-inner"></div>
                </div>
                
                <div style="width: 20px;"></div> </div>
        </div>

        <div id="screen-edit" class="screen">
            <div class="ui-top">
                <div style="font-family:var(--font-code);">EDIT MODE</div>
                <button class="btn-action outline" style="width:auto; padding:5px 15px; font-size:0.8rem;" onclick="OS.finishEdit()">DONE & PRINT ></button>
            </div>
            <div class="edit-area">
                <div id="edit-canvas-container">
                    <canvas id="edit-canvas-layer" class="drawing-layer"></canvas>
                </div>
                <div class="sticker-drawer" id="sticker-drawer">
                    <div class="sticker-item" onclick="OS.addSticker('‚ù§Ô∏è')">‚ù§Ô∏è</div>
                    <div class="sticker-item" onclick="OS.addSticker('‚ú®')">‚ú®</div>
                    <div class="sticker-item" onclick="OS.addSticker('üî•')">üî•</div>
                    <div class="sticker-item" onclick="OS.addSticker('üëë')">üëë</div>
                    <div class="sticker-item" onclick="OS.addSticker('üéÄ')">üéÄ</div>
                    <div class="sticker-item" onclick="OS.addSticker('üíã')">üíã</div>
                    <div class="sticker-item" onclick="OS.addSticker('üï∂Ô∏è')">üï∂Ô∏è</div>
                    <div class="sticker-item" onclick="OS.addSticker('üåà')">üåà</div>
                </div>
            </div>
            <div class="edit-toolbar">
                <button class="tool-btn" onclick="OS.toggleStickerDrawer()">‚ò∫</button>
                <button class="tool-btn" onclick="OS.togglePen()" id="btn-pen">‚úé</button>
                <button class="tool-btn" style="color:var(--alert); border-color:var(--alert);" onclick="OS.clearDraw()">üóë</button>
                <button class="tool-btn" onclick="OS.retake()">‚Ü∫</button>
            </div>
        </div>

        <div id="screen-result" class="screen">
            <div class="printer-wrapper">
                <div class="printer-slot">
                    <img id="final-img" class="preview-img" alt="Print">
                </div>
            </div>

            <div class="result-sidebar" id="res-sidebar">
                
                <div class="server-log" id="server-status">
                    <div id="log-text">> UPLOADING...</div>
                    <div class="loading-bar"><div class="loading-fill" id="load-fill"></div></div>
                </div>

                <div class="qr-container" id="qr-box">
                    <div id="qrcode" style="display:flex;justify-content:center;"></div>
                    <div style="font-size:0.8rem; color:#000; margin-top:5px; font-weight:bold;">SCAN TO DOWNLOAD</div>
                </div>

                <div class="print-control">
                    <span style="color:#aaa; font-size:0.8rem;">COPIES</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button class="tool-btn" style="width:30px; height:30px; font-size:1rem;" onclick="OS.adjCopies(-1)">-</button>
                        <span id="copy-count" style="font-family:var(--font-code); font-size:1.2rem;">1</span>
                        <button class="tool-btn" style="width:30px; height:30px; font-size:1rem;" onclick="OS.adjCopies(1)">+</button>
                    </div>
                </div>

                <div class="email-box">
                    <input type="email" placeholder="Enter Email" class="email-input">
                    <button class="btn-action" style="width:auto; padding:0 15px;" onclick="alert('Sent!')">SEND</button>
                </div>
                
                <div class="action-btns">
                    <button class="btn-action" onclick="OS.download()">SAVE IMAGE</button>
                    <button class="btn-action outline" onclick="OS.restart()">HOME</button>
                </div>
            </div>
        </div>
    </div>

    <div id="flash"></div>
    <canvas id="hidden-canvas" style="display:none"></canvas> 

    <script>
        // Fullscreen Toggle for iPad/Kiosk
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e=>{});
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        const OS = (function() {
            
            // --- CONFIGURATION ---
            // ‡πÉ‡∏™‡πà API KEY ‡∏Ç‡∏≠‡∏á imgbb ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∞‡πÉ‡∏ä‡πâ Demo Mode
            const API_KEY = 'YOUR_IMGBB_API_KEY'; 

            const C = {
                w: 1280, h: 720,
                stripW: 600,
                shots: 3, 
                quotes: ["SENA PRO", "GOOD VIBES", "MEMORIES", "ICONIC", "KEEP SMILING"]
            };

            // --- STATE ---
            let s = { 
                filter: 'normal', 
                frame: 'polaroid',
                photos: [], 
                stream: null, 
                processing: false,
                timer: 3,
                flash: true,
                facingMode: 'user',
                mirror: true,
                copies: 1,
                stickers: [], // {x,y,char}
                isDrawing: false,
                penEnabled: false
            };

            // --- DOM ELEMENTS ---
            const D = {
                screens: {
                    boot: document.getElementById('screen-boot'),
                    home: document.getElementById('screen-home'),
                    frames: document.getElementById('screen-frames'),
                    cam: document.getElementById('screen-cam'),
                    edit: document.getElementById('screen-edit'),
                    res: document.getElementById('screen-result')
                },
                video: document.getElementById('video-feed'),
                canvas: document.getElementById('hidden-canvas'),
                count: document.getElementById('countdown'),
                flash: document.getElementById('flash'),
                final: document.getElementById('final-img'),
                btnTimer: document.getElementById('btn-timer'),
                editContainer: document.getElementById('edit-canvas-container'),
                editLayer: document.getElementById('edit-canvas-layer'),
                stickerDrawer: document.getElementById('sticker-drawer'),
                btnPen: document.getElementById('btn-pen')
            };

            // --- AUDIO ENGINE ---
            const Aud = {
                ctx: null,
                init: function() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
                play: function(type) {
                    this.init();
                    if(this.ctx.state === 'suspended') this.ctx.resume();
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    
                    const t = this.ctx.currentTime;
                    if(type === 'coin') { 
                        o.frequency.setValueAtTime(1200, t); 
                        o.frequency.exponentialRampToValueAtTime(1800, t+0.1);
                        g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.4);
                        o.start(t); o.stop(t+0.4); 
                    }
                    else if(type === 'beep') { 
                        o.type='square'; o.frequency.value = 800; g.gain.value = 0.05; 
                        o.start(t); o.stop(t+0.1); 
                    }
                    else if(type === 'shutter') { 
                        const noise = this.ctx.createBufferSource();
                        const buffer = this.ctx.createBuffer(1, this.ctx.sampleRate * 0.1, this.ctx.sampleRate);
                        const data = buffer.getChannelData(0);
                        for (let i = 0; i < buffer.length; i++) data[i] = Math.random() * 2 - 1;
                        noise.buffer = buffer; noise.connect(g);
                        g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
                        noise.start(t);
                    }
                },
                speak: function(text) {
                    if('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(text);
                        u.rate = 1.2; u.pitch = 1.1;
                        window.speechSynthesis.speak(u);
                    }
                }
            };

            // --- INITIALIZATION ---
            window.onload = async () => {
                const logs = ["SENA OS PRO v3.0", "LOADING ASSETS...", "INIT CAMERA...", "SYSTEM READY."];
                const logDiv = document.getElementById('boot-log');
                for(let l of logs) { 
                    logDiv.innerHTML += l + "<br>"; 
                    await new Promise(r => setTimeout(r, 300)); 
                }
                setTimeout(() => { switchScreen('home'); }, 500);
                
                // Clock
                setInterval(() => {
                    const d = new Date();
                    document.getElementById('clock').innerText = d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
                }, 1000);

                // Setup Draw Layer
                setupDrawing();
            };

            function switchScreen(name) {
                Object.values(D.screens).forEach(s => s.classList.remove('active'));
                D.screens[name].classList.add('active');
            }

            // --- MAIN ACTIONS ---
            async function start() {
                Aud.play('coin');
                switchScreen('frames');
            }

            async function selectFrame(type) {
                s.frame = type;
                Aud.play('beep');
                await initCamera();
                switchScreen('cam');
            }

            async function initCamera() {
                if(s.stream) s.stream.getTracks().forEach(t=>t.stop());
                try {
                    s.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: s.facingMode, width: {ideal: 1920}, height: {ideal: 1080} },
                        audio: false
                    });
                    D.video.srcObject = s.stream;
                    updateMirror();
                } catch(e) { alert("Camera Error: " + e.message); }
            }

            // --- CAMERA TOOLS ---
            function toggleCamFlip() {
                s.facingMode = (s.facingMode === 'user') ? 'environment' : 'user';
                initCamera();
            }
            function toggleTimer() {
                const timers = [3, 5, 10];
                let idx = timers.indexOf(s.timer);
                s.timer = timers[(idx+1) % timers.length];
                D.btnTimer.innerText = s.timer + "s";
                Aud.play('beep');
            }
            function toggleFlash() { s.flash = !s.flash; Aud.play('beep'); }
            function toggleMirror() { s.mirror = !s.mirror; updateMirror(); }
            function toggleGrid() { D.video.parentElement.classList.toggle('grid-on'); Aud.play('beep'); }
            
            function updateMirror() {
                // If user facing + mirror ON -> flip. If environment, usually don't flip.
                if(s.mirror) D.video.style.transform = "scaleX(-1)";
                else D.video.style.transform = "scaleX(1)";
            }

            function filter(mode, btn) {
                s.filter = mode;
                document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                let css = 'none';
                if(mode==='beauty') css = 'contrast(1.05) brightness(1.1) saturate(1.1) blur(0.5px)';
                if(mode==='bw') css = 'grayscale(100%) contrast(1.2)';
                if(mode==='film') css = 'sepia(0.3) contrast(1.1) saturate(0.8)';
                D.video.style.filter = css;
                
                if(mode==='glitch') D.video.classList.add('filter-glitch');
                else D.video.classList.remove('filter-glitch');
                
                Aud.play('beep');
            }

            // --- CAPTURE LOGIC ---
            async function snap() {
                if(s.processing) return;
                s.processing = true; s.photos = [];
                
                for(let i=0; i<C.shots; i++) {
                    await countdown(s.timer);
                    await capture();
                    await new Promise(r => setTimeout(r, 800));
                }
                
                s.processing = false;
                prepareEditMode();
            }

            function countdown(n) {
                return new Promise(r => {
                    let c = n; D.count.style.display = 'block'; D.count.innerText = c;
                    Aud.speak(c.toString());
                    const t = setInterval(() => {
                        Aud.play('beep'); c--;
                        if(c>0) { 
                            D.count.innerText = c; 
                            if(c<=3) Aud.speak(c.toString()); 
                        } else { 
                            clearInterval(t); D.count.style.display = 'none'; 
                            Aud.speak("Cheese!");
                            r(); 
                        }
                    }, 1000);
                });
            }

            function capture() {
                return new Promise(r => {
                    Aud.play('shutter');
                    if(s.flash) {
                        D.flash.classList.add('do-flash');
                        setTimeout(() => D.flash.classList.remove('do-flash'), 200);
                    }
                    
                    const cvs = document.createElement('canvas');
                    // Capture actual video resolution
                    cvs.width = D.video.videoWidth; cvs.height = D.video.videoHeight;
                    const ctx = cvs.getContext('2d');
                    
                    // Handle Mirroring for Capture
                    if(s.mirror) {
                        ctx.translate(cvs.width, 0); ctx.scale(-1, 1);
                    }
                    ctx.drawImage(D.video, 0, 0);
                    
                    // Apply Filters (Basic Canvas manip)
                    ctx.setTransform(1,0,0,1,0,0); // Reset for filtering
                    if(s.filter !== 'normal' && s.filter !== 'glitch') {
                        // Apply simplistic filter logic if needed, 
                        // or just rely on CSS filter on video (but CSS filter doesn't save to canvas ctx easily without libraries).
                        // For simplicity in this vanilla file, we apply basic color matrix.
                        const id = ctx.getImageData(0,0,cvs.width,cvs.height);
                        const d = id.data;
                        for(let i=0; i<d.length; i+=4) {
                            let R=d[i], G=d[i+1], B=d[i+2];
                            if(s.filter === 'bw') {
                                const v = 0.299*R + 0.587*G + 0.114*B; d[i]=d[i+1]=d[i+2]=v;
                            } else if(s.filter === 'film') {
                                d[i] = R*0.393+G*0.769+B*0.189; d[i+1] = R*0.349+G*0.686+B*0.168; d[i+2] = R*0.272+G*0.534+B*0.131;
                            }
                        }
                        ctx.putImageData(id, 0, 0);
                    }
                    
                    s.photos.push(cvs);
                    setTimeout(r, 200);
                });
            }

            // --- STEP 5: PROCESS & EDIT MODE ---
            function prepareEditMode() {
                // Generate base strip
                generateStripCanvas(); 
                
                // Show Edit Screen
                const baseData = D.canvas.toDataURL();
                const tempImg = new Image();
                tempImg.src = baseData;
                
                D.editContainer.innerHTML = ""; // Clear old
                D.editContainer.appendChild(tempImg);
                
                // Setup Drawing Canvas overlay
                const drawCvs = document.createElement('canvas');
                drawCvs.id = "draw-layer";
                drawCvs.width = D.canvas.width;
                drawCvs.height = D.canvas.height;
                drawCvs.style.position = "absolute";
                drawCvs.style.left = "0"; drawCvs.style.top = "0";
                drawCvs.style.width = "100%"; drawCvs.style.height = "100%";
                drawCvs.style.cursor = "crosshair";
                drawCvs.style.touchAction = "none";
                D.editContainer.appendChild(drawCvs);
                
                // Scale container to fit screen height
                const h = window.innerHeight - 150; // toolbar space
                const aspect = D.canvas.width / D.canvas.height;
                D.editContainer.style.height = h + "px";
                D.editContainer.style.width = (h * aspect) + "px";
                
                setupDrawingEvents(drawCvs);
                s.stickers = []; // Reset stickers
                
                switchScreen('edit');
            }
            
            // --- EDITING TOOLS ---
            let drawCtx = null;
            function setupDrawingEvents(canvas) {
                drawCtx = canvas.getContext('2d');
                drawCtx.lineJoin = 'round'; drawCtx.lineCap = 'round'; drawCtx.lineWidth = 5; drawCtx.strokeStyle = '#ff0055';
                
                let painting = false;
                
                function getPos(e) {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
                }
                
                function startDraw(e) {
                    if(!s.penEnabled) return;
                    painting = true; const p = getPos(e);
                    drawCtx.beginPath(); drawCtx.moveTo(p.x, p.y);
                }
                function moveDraw(e) {
                    if(!painting || !s.penEnabled) return;
                    e.preventDefault(); const p = getPos(e);
                    drawCtx.lineTo(p.x, p.y); drawCtx.stroke();
                }
                function endDraw() { painting = false; }
                
                canvas.addEventListener('mousedown', startDraw);
                canvas.addEventListener('mousemove', moveDraw);
                canvas.addEventListener('mouseup', endDraw);
                canvas.addEventListener('touchstart', startDraw);
                canvas.addEventListener('touchmove', moveDraw);
                canvas.addEventListener('touchend', endDraw);
            }

            function togglePen() {
                s.penEnabled = !s.penEnabled;
                D.btnPen.classList.toggle('active', s.penEnabled);
            }
            function clearDraw() {
                if(drawCtx) drawCtx.clearRect(0,0,drawCtx.canvas.width, drawCtx.canvas.height);
                // Remove sticker elements
                document.querySelectorAll('.placed-sticker').forEach(e => e.remove());
                s.stickers = [];
            }
            function toggleStickerDrawer() {
                D.stickerDrawer.classList.toggle('open');
            }
            function addSticker(char) {
                // Add DOM element for manipulation
                const el = document.createElement('div');
                el.className = 'placed-sticker';
                el.innerText = char;
                el.style.left = "50%"; el.style.top = "50%";
                D.editContainer.appendChild(el);
                
                // Simple Drag logic
                let isDragging = false;
                
                const onMove = (e) => {
                    if(!isDragging) return;
                    e.preventDefault();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    const rect = D.editContainer.getBoundingClientRect();
                    el.style.left = (clientX - rect.left) + "px";
                    el.style.top = (clientY - rect.top) + "px";
                };
                
                el.addEventListener('mousedown', () => isDragging = true);
                el.addEventListener('touchstart', () => isDragging = true);
                window.addEventListener('mouseup', () => isDragging = false);
                window.addEventListener('touchend', () => isDragging = false);
                window.addEventListener('mousemove', onMove);
                window.addEventListener('touchmove', onMove);
            }

            function retake() {
                if(confirm("Retake photos?")) {
                    switchScreen('cam');
                }
            }

            // --- FINAL RENDER ---
            async function finishEdit() {
                // 1. Draw base strip
                const ctx = D.canvas.getContext('2d');
                
                // 2. Draw Drawings
                const drawCanvas = document.getElementById('draw-layer');
                if(drawCanvas) ctx.drawImage(drawCanvas, 0, 0);
                
                // 3. Draw Stickers (Convert DOM pos to Canvas pos)
                const stickers = document.querySelectorAll('.placed-sticker');
                const containerRect = D.editContainer.getBoundingClientRect();
                const scaleX = D.canvas.width / containerRect.width;
                const scaleY = D.canvas.height / containerRect.height;
                
                ctx.font = "100px sans-serif";
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                
                stickers.forEach(el => {
                    const rect = el.getBoundingClientRect();
                    // relative to container
                    const relX = (rect.left - containerRect.left) + (rect.width/2);
                    const relY = (rect.top - containerRect.top) + (rect.height/2);
                    
                    const cvsX = relX * scaleX;
                    const cvsY = relY * scaleY;
                    ctx.fillText(el.innerText, cvsX, cvsY);
                });

                // Display Final
                const finalDataUrl = D.canvas.toDataURL('image/jpeg', 0.95);
                D.final.src = finalDataUrl;
                switchScreen('res');
                
                // Effects
                D.final.classList.add('printing-active');
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                
                // Upload
                setTimeout(() => { 
                    document.getElementById('res-sidebar').classList.add('show'); 
                    handleUpload(finalDataUrl); 
                }, 3500);
            }

            // --- STRIP GENERATION LOGIC (Existing + Refined) ---
            function generateStripCanvas() {
                const f = s.frame;
                let stripW = C.stripW; 
                let photoW = 540, photoH = (photoW*3)/4;
                let gap = 25, head = 150, foot = 100;
                let H = head + (photoH*C.shots) + (gap*(C.shots-1)) + foot;

                D.canvas.width = stripW; D.canvas.height = H;
                const ctx = D.canvas.getContext('2d');

                // BG
                if(f === 'disco') {
                    ctx.fillStyle = '#111'; ctx.fillRect(0,0,stripW,H);
                    // Simple dots
                    ctx.fillStyle = 'rgba(255,255,255,0.1)';
                    for(let i=0; i<100; i++) ctx.fillRect(Math.random()*stripW, Math.random()*H, 4, 4);
                } else if(f === 'black') { ctx.fillStyle = '#111'; ctx.fillRect(0,0,stripW,H); }
                else if(f === 'system') { ctx.fillStyle = '#000'; ctx.fillRect(0,0,stripW,H); }
                else { ctx.fillStyle = '#f8f8f8'; ctx.fillRect(0,0,stripW,H); }

                // HEADER
                ctx.textAlign = 'center';
                if(f === 'love') {
                    ctx.fillStyle = '#000'; ctx.font = 'bold 60px "DM Sans"'; ctx.fillText('I', stripW/2 - 130, 100);
                    ctx.fillStyle = '#FF0000'; ctx.font = '70px "DM Sans"'; ctx.fillText('‚ô•', stripW/2 - 50, 100);
                    ctx.fillStyle = '#000'; ctx.font = 'bold 60px "DM Sans"'; ctx.fillText('SENA', stripW/2 + 100, 100);
                } else if(f === 'system') {
                    ctx.fillStyle = '#0f0'; ctx.font = '40px "VT323"'; ctx.fillText('SYS.LOG: CAPTURED', stripW/2, 80);
                    ctx.strokeStyle = '#0f0'; ctx.lineWidth = 2; ctx.strokeRect(10,10,stripW-20,H-20);
                } else {
                    ctx.fillStyle = (f==='black'||f==='disco') ? '#fff' : '#000';
                    ctx.font = 'bold 40px "DM Sans"'; ctx.fillText('SENA', stripW/2, 80);
                    ctx.font = '700 24px "DM Sans"'; ctx.fillText('PHOTOBOOTH', stripW/2, 120);
                }

                // PHOTOS
                let y = head;
                s.photos.forEach(p => {
                    const sR = p.width/p.height; const dR=4/3;
                    let sx, sy, sw, sh;
                    if(sR > dR) { sh=p.height; sw=sh*dR; sx=(p.width-sw)/2; sy=0; }
                    else { sw=p.width; sh=sw/dR; sx=0; sy=(p.height-sh)/2; }
                    
                    if(f === 'system') { ctx.strokeStyle = '#0f0'; ctx.lineWidth=2; ctx.strokeRect((stripW-photoW)/2 - 5, y - 5, photoW + 10, photoH + 10); }
                    else if(f === 'love') { ctx.strokeStyle = '#FF0000'; ctx.lineWidth=4; ctx.strokeRect((stripW-photoW)/2, y, photoW, photoH); }

                    ctx.drawImage(p, sx, sy, sw, sh, (stripW-photoW)/2, y, photoW, photoH);
                    y += photoH + gap;
                });

                // FOOTER
                const quote = C.quotes[Math.floor(Math.random()*C.quotes.length)];
                ctx.font = '20px "VT323"'; ctx.textAlign = 'center'; 
                ctx.fillStyle = (f==='system') ? '#0f0' : (f==='black'||f==='disco') ? '#888' : '#666';
                
                const date = new Date().toLocaleDateString('en-GB');
                let footerText = date + "  ‚Ä¢  " + quote;
                if(f === 'system') footerText = `> ${date} // END_PROCESS`;
                ctx.fillText(footerText, stripW/2, H - 40);
            }

            function setupDrawing() { /* Init Place holder */ }

            // --- SERVER & UTILS ---
            async function handleUpload(base64) {
                // Mock or Real Upload
                const log = document.getElementById('log-text');
                const fill = document.getElementById('load-fill');
                
                // Simulating upload progress
                let p = 0;
                const int = setInterval(() => { p+=5; if(p<=90) fill.style.width=p+"%"; }, 100);

                // Fallback / Demo Mode
                setTimeout(() => {
                    clearInterval(int);
                    fill.style.width="100%";
                    log.innerText = "> READY FOR DOWNLOAD";
                    
                    // Generate QR (Current URL for demo)
                    document.getElementById('qrcode').innerHTML = "";
                    new QRCode(document.getElementById("qrcode"), {
                        text: window.location.href, width: 120, height: 120
                    });
                    document.getElementById('qr-box').classList.add('show');
                }, 2000);
            }

            function adjCopies(n) {
                s.copies = Math.max(1, s.copies + n);
                document.getElementById('copy-count').innerText = s.copies;
            }

            function download() {
                const a = document.createElement('a');
                a.download = `SENA_${Date.now()}.jpg`;
                a.href = D.final.src;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }

            function restart() {
                location.reload();
            }

            return { 
                start, selectFrame, toggleCamFlip, toggleTimer, toggleFlash, toggleMirror, toggleGrid, 
                filter, snap, finishEdit, toggleStickerDrawer, addSticker, togglePen, clearDraw, retake,
                adjCopies, download, restart 
            };
        })();
    </script>
</body>
</html>
