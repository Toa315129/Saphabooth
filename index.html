<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENA PHOTOBOOTH | OS 4.5 ULTIMATE</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700;800&family=VT323&family=Fredoka:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           KEEPING ORIGINAL STYLES + NEW UPDATES
           ========================================= */
        :root { --bg-color: #050505; --primary: #4169E1; --font-ui: 'DM Sans', sans-serif; --font-code: 'VT323', monospace; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg-color); height: 100vh; width: 100vw; overflow: hidden; color: #fff; font-family: var(--font-ui); display: flex; justify-content: center; align-items: center; }

        /* ... (Background Effects remain same) ... */
        .scanlines { position: absolute; inset: 0; pointer-events: none; z-index: 900; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); background-size: 100% 4px; }
        .grain { position: absolute; inset: 0; pointer-events: none; z-index: 899; opacity: 0.04; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }

        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transform: scale(0.95); transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 10; }
        .screen.active { opacity: 1; pointer-events: auto; transform: scale(1); }

        /* HOME UI UPDATES */
        #screen-home { justify-content: center; align-items: center; text-align: center; background: radial-gradient(circle at center, #222 0%, #000 100%); }
        .main-title { font-size: 5rem; font-weight: 800; line-height: 0.9; letter-spacing: -3px; margin-bottom: 20px; text-shadow: 0 0 40px rgba(65, 105, 225, 0.5); }
        .input-name { background: transparent; border: none; border-bottom: 2px solid #555; color: #fff; font-family: var(--font-code); font-size: 1.5rem; text-align: center; margin-top: 20px; width: 250px; outline: none; text-transform: uppercase; transition: 0.3s; }
        .input-name:focus { border-color: var(--primary); width: 300px; }
        
        .btn-start { margin-top: 30px; background: transparent; border: 2px solid #fff; padding: 15px 50px; color: #fff; font-family: var(--font-code); font-size: 1.5rem; cursor: pointer; transition: 0.3s; }
        .btn-start:hover { background: #fff; color: #000; box-shadow: 0 0 20px #fff; }

        /* FRAMES & LAYOUT SELECTION */
        #screen-frames { background: #111; padding: 20px; align-items: center; }
        .layout-toggles { display: flex; gap: 20px; margin-bottom: 20px; z-index: 100; }
        .btn-layout { padding: 10px 20px; border: 1px solid #444; background: #000; color: #888; cursor: pointer; border-radius: 20px; font-family: var(--font-code); transition: 0.2s; display: flex; align-items: center; gap: 5px;}
        .btn-layout.active { border-color: #fff; color: #fff; background: #222; box-shadow: 0 0 15px rgba(255,255,255,0.2); }
        
        .frame-scroller { display: flex; gap: 30px; overflow-x: auto; padding: 20px; width: 100%; justify-content: center; }
        .mini-strip { width: 120px; height: 320px; flex-shrink: 0; display: flex; flex-direction: column; padding: 8px; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-radius: 4px; border: 1px solid #333; }
        .mini-strip:hover { transform: translateY(-10px) scale(1.05); border-color: #fff; }
        
        /* Grid Preview Style */
        .mini-strip.grid-mode { width: 200px; height: 260px; flex-wrap: wrap; flex-direction: row; align-content: flex-start; gap: 4px; }
        .mini-strip.grid-mode .photo-slot { width: 48%; height: 80px; margin-bottom: 0; }
        .mini-strip.grid-mode .strip-header { width: 100%; margin-bottom: 5px; }
        .mini-strip.grid-mode .strip-footer { width: 100%; margin-top: auto; }

        .photo-slot { flex: 1; background: rgba(0,0,0,0.2); margin-bottom: 4px; border: 1px dashed rgba(255,255,255,0.1); }
        
        /* Different Themes */
        .mini-strip.fuji { background: #004d40; }
        .mini-strip.pink { background: #FFC0CB; color: #ff1493; }
        .mini-strip.bw { background: #fff; color: #000; }
        .mini-strip.cyber { background: #000; border: 1px solid #0f0; color: #0f0; box-shadow: 0 0 10px #0f0; }

        /* CAMERA UI */
        #screen-cam { background: #000; flex-direction: row; position: relative; }
        .viewport-container { flex: 1; position: relative; height: 100%; display: flex; flex-direction: column; background: #000; }
        video#video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .cam-sidebar { width: 140px; background: #111; border-left: 1px solid #333; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 20px 10px; z-index: 60; }
        
        /* Filters */
        .f-fuji { filter: contrast(1.1) brightness(1.1) saturate(0.9) hue-rotate(-5deg) !important; }
        .f-1998 { filter: sepia(0.2) saturate(1.4) contrast(1.1) hue-rotate(-10deg) !important; }
        .f-bw { filter: grayscale(1) contrast(1.2) !important; }
        
        /* Controls */
        .btn-shutter { width: 80px; height: 80px; border: 4px solid #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; background: transparent; }
        .shutter-inner { width: 68px; height: 68px; background: #fff; border-radius: 50%; transition: 0.1s; }
        .btn-shutter:active .shutter-inner { transform: scale(0.9); background: #ccc; }
        .btn-filter { width: 100%; padding: 8px; background: transparent; border: 1px solid #444; color: #888; margin-bottom: 5px; border-radius: 4px; cursor: pointer; font-family: var(--font-code); }
        .btn-filter.active { background: #fff; color: #000; }

        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 15rem; font-weight: 800; color: #fff; display: none; text-shadow: 4px 4px 0 #000; z-index: 100; }

        /* RESULT & PRINT */
        #screen-result { background: #111; flex-direction: row; gap: 40px; padding: 40px; justify-content: center; align-items: flex-start; overflow-y: auto;}
        .printer-slot { width: auto; max-width: 500px; min-height: 500px; background: #000; border: 10px solid #222; border-radius: 10px; box-shadow: 0 0 50px rgba(0,0,0,0.8); padding: 20px; display: flex; justify-content: center; }
        .final-print { max-width: 100%; max-height: 80vh; display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        .result-ui { width: 280px; display: flex; flex-direction: column; gap: 10px; opacity: 0; animation: fadeIn 1s ease 1s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .btn-action { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-family: var(--font-ui); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-pri { background: var(--primary); color: #fff; }
        .btn-sec { background: transparent; border: 1px solid #555; color: #ccc; }

        /* FLASH */
        #flash { position: fixed; inset: 0; background: #fff; z-index: 999; opacity: 0; pointer-events: none; }
        .do-flash { animation: flashAnim 0.3s ease-out; }
        @keyframes flashAnim { 0% { opacity: 1; } 100% { opacity: 0; } }

        /* Responsive */
        @media (max-width: 800px) {
            #screen-cam { flex-direction: column; }
            .cam-sidebar { width: 100%; height: auto; flex-direction: row; padding: 10px; order: 2; overflow-x: auto; }
            .viewport-container { order: 1; flex: 1; }
            #screen-result { flex-direction: column; padding: 20px; }
            .printer-slot { width: 100%; padding: 10px; border-width: 5px; }
            .main-title { font-size: 3.5rem; }
            .btn-filter { width: auto; padding: 5px 15px; white-space: nowrap; margin: 0 5px; }
        }
    </style>
</head>
<body>

    <div class="scanlines"></div>
    <div class="grain"></div>

    <div id="screen-home" class="screen active">
        <div class="main-title">SENA<br>OS 4.5</div>
        <div style="font-family:var(--font-code); color:#888; letter-spacing:4px;">ULTIMATE EDITION</div>
        
        <input type="text" id="user-name" class="input-name" placeholder="TYPE YOUR NAME" maxlength="12">
        
        <button class="btn-start" onclick="OS.start()">START</button>
        <p style="margin-top:20px; opacity:0.5; font-size:0.8rem; font-family:var(--font-code);">[SPACEBAR] TO START</p>
    </div>

    <div id="screen-frames" class="screen">
        <h2 style="text-align:center; font-family:var(--font-code); margin-bottom:10px;">SELECT LAYOUT</h2>
        
        <div class="layout-toggles">
            <div class="btn-layout active" onclick="OS.setLayout('strip', this)">üéû STRIP (1x4)</div>
            <div class="btn-layout" onclick="OS.setLayout('grid', this)">‚äû GRID (2x2)</div>
        </div>

        <div class="frame-scroller" id="frame-container">
            <div class="mini-strip fuji" onclick="OS.selectFrame('fuji')">
                <div class="strip-header">FUJI</div>
                <div class="photo-slot" style="background:#00332a"></div>
                <div class="photo-slot" style="background:#00332a"></div>
                <div class="photo-slot" style="background:#00332a"></div>
                <div class="photo-slot" style="background:#00332a"></div>
                <div class="strip-footer">STD</div>
            </div>

            <div class="mini-strip pink" onclick="OS.selectFrame('pink')">
                <div class="strip-header">Y2K</div>
                <div class="photo-slot" style="background:#FFF0F5"></div>
                <div class="photo-slot" style="background:#FFF0F5"></div>
                <div class="photo-slot" style="background:#FFF0F5"></div>
                <div class="photo-slot" style="background:#FFF0F5"></div>
                <div class="strip-footer">CUTE</div>
            </div>

            <div class="mini-strip bw" onclick="OS.selectFrame('bw')">
                <div class="strip-header">BW</div>
                <div class="photo-slot" style="background:#eee"></div>
                <div class="photo-slot" style="background:#eee"></div>
                <div class="photo-slot" style="background:#eee"></div>
                <div class="photo-slot" style="background:#eee"></div>
                <div class="strip-footer">CLASSIC</div>
            </div>
            
            <div class="mini-strip cyber" onclick="OS.selectFrame('cyber')">
                <div class="strip-header">CYBER</div>
                <div class="photo-slot" style="background:#000"></div>
                <div class="photo-slot" style="background:#000"></div>
                <div class="photo-slot" style="background:#000"></div>
                <div class="photo-slot" style="background:#000"></div>
                <div class="strip-footer">HACKER</div>
            </div>
        </div>
    </div>

    <div id="screen-cam" class="screen">
        <div class="viewport-container">
            <video id="video-feed" autoplay playsinline muted></video>
            <div id="countdown">3</div>
            <div style="position:absolute; top:20px; left:20px; color:red; font-weight:bold; font-family:var(--font-code);">‚óè REC</div>
        </div>

        <div class="cam-sidebar">
            <div style="width:100%">
                <div style="font-size:0.6rem; color:#555; text-align:center; margin-bottom:5px;">FILTERS</div>
                <button class="btn-filter active" onclick="OS.setFilter('normal', this)">NORMAL</button>
                <button class="btn-filter" onclick="OS.setFilter('fuji', this)">üóª FUJI</button>
                <button class="btn-filter" onclick="OS.setFilter('1998', this)">üåá 1998</button>
                <button class="btn-filter" onclick="OS.setFilter('bw', this)">üèÅ B/W</button>
            </div>

            <div style="text-align:center;">
                <div class="btn-shutter" onclick="OS.snap()">
                    <div class="shutter-inner"></div>
                </div>
                <div style="font-size:0.6rem; margin-top:5px; color:#555;">[SPACE]</div>
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="printer-slot">
            <img id="final-img" class="final-print" alt="Print">
        </div>
        
        <div class="result-ui">
            <div style="background:#222; padding:15px; border-radius:6px; margin-bottom:10px;">
                <div style="color:#aaa; font-size:0.8rem;">PRINTER STATUS</div>
                <div style="color:#0f0; font-family:var(--font-code);">READY TO PRINT</div>
            </div>

            <button class="btn-action btn-pri" onclick="window.print()">üñ®Ô∏è PRINT PHOTO</button>
            <button class="btn-action btn-sec" onclick="OS.download()">‚¨á SAVE JPEG</button>
            <button class="btn-action btn-sec" onclick="location.reload()">‚Üª NEW SHOOT</button>
            
            <div id="qrcode" style="margin-top:10px; background:#fff; padding:5px; align-self:center; border-radius:4px;"></div>
        </div>
    </div>

    <div id="flash"></div>
    <canvas id="hidden-canvas" style="display:none"></canvas>

    <script>
        const OS = (function() {
            // CONFIGURATION
            const C = {
                w: 1280, h: 720,
                shots: 4, // 4 Shots standard
                emojiList: ["‚ú®", "üíñ", "ü¶ã", "üåô", "üî•", "üçí", "üß∏"]
            };

            // APP STATE
            let s = { 
                layout: 'strip', // 'strip' or 'grid'
                filter: 'normal',
                frame: 'fuji',
                userName: 'SENA',
                photos: [],
                stream: null,
                processing: false
            };

            const D = {
                screens: { home: document.getElementById('screen-home'), frames: document.getElementById('screen-frames'), cam: document.getElementById('screen-cam'), res: document.getElementById('screen-result') },
                video: document.getElementById('video-feed'),
                canvas: document.getElementById('hidden-canvas'),
                count: document.getElementById('countdown'),
                flash: document.getElementById('flash'),
                final: document.getElementById('final-img'),
                inputName: document.getElementById('user-name')
            };

            const Aud = {
                ctx: new (window.AudioContext||window.webkitAudioContext)(),
                play: (f, t, d) => {
                    if(Aud.ctx.state==='suspended') Aud.ctx.resume();
                    const o=Aud.ctx.createOscillator(), g=Aud.ctx.createGain();
                    o.type=t; o.frequency.value=f; o.connect(g); g.connect(Aud.ctx.destination);
                    g.gain.setValueAtTime(0.1, Aud.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, Aud.ctx.currentTime+d);
                    o.start(); o.stop(Aud.ctx.currentTime+d);
                }
            };

            // --- FUNCTIONS ---
            function start() {
                if(D.inputName.value.trim() !== "") s.userName = D.inputName.value.toUpperCase();
                Aud.play(600, 'sine', 0.2);
                switchScreen('frames');
            }

            function setLayout(type, btn) {
                s.layout = type;
                document.querySelectorAll('.btn-layout').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Visual update for frame preview
                document.querySelectorAll('.mini-strip').forEach(el => {
                    if(type === 'grid') el.classList.add('grid-mode');
                    else el.classList.remove('grid-mode');
                });
            }

            async function selectFrame(type) {
                s.frame = type;
                try {
                    s.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: C.w, height: C.h } });
                    D.video.srcObject = s.stream;
                    switchScreen('cam');
                } catch(e) { alert("Camera Error: " + e.message); }
            }

            function setFilter(mode, btn) {
                s.filter = mode;
                document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                D.video.className = ''; 
                if(mode !== 'normal') D.video.classList.add('f-'+mode);
            }

            async function snap() {
                if(s.processing) return;
                s.processing = true; s.photos = [];
                
                for(let i=0; i<C.shots; i++) {
                    await countdown(3);
                    await capture();
                    await new Promise(r => setTimeout(r, 800));
                }
                process();
            }

            function countdown(n) {
                return new Promise(r => {
                    let c = n; D.count.style.display = 'block'; D.count.innerText = c;
                    Aud.play(800, 'square', 0.1);
                    const t = setInterval(() => {
                        c--;
                        if(c>0) { D.count.innerText = c; Aud.play(800, 'square', 0.1); }
                        else { clearInterval(t); D.count.style.display = 'none'; r(); }
                    }, 1000);
                });
            }

            function capture() {
                return new Promise(r => {
                    Aud.play(150, 'sawtooth', 0.2);
                    D.flash.classList.add('do-flash');
                    setTimeout(() => D.flash.classList.remove('do-flash'), 300);
                    
                    const cvs = document.createElement('canvas');
                    cvs.width = D.video.videoWidth; cvs.height = D.video.videoHeight;
                    const ctx = cvs.getContext('2d');
                    
                    // Mirror & Draw
                    ctx.translate(cvs.width, 0); ctx.scale(-1, 1);
                    // Filter Application (Hardcoded for Canvas)
                    if(s.filter === 'fuji') ctx.filter = 'contrast(1.1) brightness(1.1) saturate(0.9) hue-rotate(-5deg)';
                    else if(s.filter === '1998') ctx.filter = 'sepia(0.2) saturate(1.4) contrast(1.1) hue-rotate(-10deg)';
                    else if(s.filter === 'bw') ctx.filter = 'grayscale(1) contrast(1.2)';
                    
                    ctx.drawImage(D.video, 0, 0);
                    ctx.filter = 'none';
                    s.photos.push(cvs);
                    setTimeout(r, 100);
                });
            }

            function process() {
                if(s.stream) s.stream.getTracks().forEach(t=>t.stop());
                
                // Determine sizes based on layout
                const isGrid = s.layout === 'grid';
                const stripW = isGrid ? 800 : 600;
                // Dimensions calculation
                const gap = 30; const border = 40; 
                const headerH = 160; const footerH = 100;
                
                let photoW, photoH, canvasH;
                
                if (isGrid) {
                    // 2x2 Layout
                    photoW = (stripW - (border*2) - gap) / 2;
                    photoH = photoW * 0.75; // Landscape-ish crop
                    canvasH = headerH + (photoH*2) + gap + footerH + border;
                } else {
                    // 1x4 Strip
                    photoW = stripW - (border*2);
                    photoH = photoW * 0.75;
                    canvasH = headerH + (photoH*4) + (gap*3) + footerH + border;
                }

                D.canvas.width = stripW; D.canvas.height = canvasH;
                const ctx = D.canvas.getContext('2d');

                // 1. DRAW BACKGROUND
                let bg, fg, borderC;
                if(s.frame === 'fuji') { bg='#004d40'; fg='#e0f2f1'; borderC='#00695c'; }
                else if(s.frame === 'pink') { bg='#FFC0CB'; fg='#ff1493'; borderC='#FF69B4'; }
                else if(s.frame === 'cyber') { bg='#000'; fg='#0f0'; borderC='#0f0'; }
                else { bg='#fff'; fg='#000'; borderC='#ccc'; }

                ctx.fillStyle = bg; ctx.fillRect(0,0,stripW,canvasH);
                
                // Inner border
                if(s.frame !== 'pink') {
                    ctx.strokeStyle = borderC; ctx.lineWidth = 2;
                    ctx.strokeRect(15,15,stripW-30,canvasH-30);
                }

                // 2. HEADER TEXT
                ctx.textAlign = 'center'; 
                ctx.fillStyle = fg;
                
                if(s.frame === 'pink') {
                    ctx.font = 'bold 60px "Fredoka"'; ctx.fillText(s.userName, stripW/2, 80);
                    ctx.font = '30px "Fredoka"'; ctx.fillText('‚ô• MEMORIES ‚ô•', stripW/2, 125);
                } else if (s.frame === 'cyber') {
                    ctx.font = '60px "VT323"'; ctx.fillText(s.userName, stripW/2, 80);
                    ctx.font = '30px "VT323"'; ctx.fillText('SYSTEM_OVERRIDE', stripW/2, 120);
                } else {
                    ctx.font = 'bold 50px "DM Sans"'; ctx.fillText(s.userName, stripW/2, 90);
                    ctx.font = '24px "DM Sans"'; ctx.fillText(new Date().toDateString(), stripW/2, 130);
                }

                // 3. DRAW PHOTOS
                s.photos.forEach((p, i) => {
                    let x, y;
                    
                    if(isGrid) {
                        // Grid Logic: 0=TL, 1=TR, 2=BL, 3=BR
                        const col = i % 2;
                        const row = Math.floor(i / 2);
                        x = border + (col * (photoW + gap));
                        y = headerH + (row * (photoH + gap));
                    } else {
                        // Strip Logic
                        x = border;
                        y = headerH + (i * (photoH + gap));
                    }

                    // Crop center of video to fit aspect ratio
                    const sR = p.width/p.height; const dR = photoW/photoH;
                    let sx, sy, sw, sh;
                    if(sR > dR) { sh=p.height; sw=sh*dR; sx=(p.width-sw)/2; sy=0; }
                    else { sw=p.width; sh=sw/dR; sx=0; sy=(p.height-sh)/2; }

                    // Draw Image
                    ctx.drawImage(p, sx, sy, sw, sh, x, y, photoW, photoH);
                    
                    // Decoration (Simple Timestamp on last photo or corner)
                    if(i === 3 && s.frame === 'fuji') {
                        ctx.fillStyle = "#FF8C00"; ctx.font = '16px "VT323"'; ctx.textAlign='right';
                        ctx.fillText("'98 " + new Date().getDate(), x+photoW-10, y+photoH-10);
                    }
                });

                // 4. FOOTER
                ctx.textAlign = 'center'; ctx.fillStyle = fg;
                let footerY = canvasH - 40;
                
                if (s.frame === 'pink') {
                     ctx.font = '30px Arial'; ctx.fillText("‚ú® üß∏ üéÄ üç≠", stripW/2, footerY);
                } else if (s.frame === 'cyber') {
                     ctx.font = '20px "VT323"'; ctx.fillText("ID: " + Math.random().toString(36).substr(2,9).toUpperCase(), stripW/2, footerY);
                } else {
                     ctx.font = '16px "DM Sans"'; ctx.fillText("SENA PHOTOBOOTH OS 4.5", stripW/2, footerY);
                }

                D.final.src = D.canvas.toDataURL('image/jpeg', 0.95);
                switchScreen('res');
                Aud.play(1000, 'sine', 0.5);
                
                // QR Code
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), { text: window.location.href, width: 80, height: 80 });
            }

            function switchScreen(name) {
                Object.values(D.screens).forEach(s => s.classList.remove('active'));
                D.screens[name].classList.add('active');
            }

            function download() {
                const a = document.createElement('a'); a.download = `SENA_${s.userName}_${Date.now()}.jpg`;
                a.href = D.final.src; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }

            // Keyboard
            document.addEventListener('keydown', (e) => {
                if(e.code==='Space') {
                    if(D.screens.home.classList.contains('active')) start();
                    else if(D.screens.cam.classList.contains('active')) snap();
                }
            });

            return { start, selectFrame, setLayout, setFilter, snap, download };
        })();
    </script>
</body>
</html>
