<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>SENA DREAMY | PASTEL BOOTH</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           1. PASTEL Y2K THEME
           ========================================= */
        :root {
            --bg-cream: #FCF9D9;      
            --blob-blue: #A3D8E2;     
            --star-pink: #F5A3C7;     
            --text-purple: #5E4B8B;   
            --ui-white: #FFFFFF;
            
            --font-head: 'Pacifico', cursive;  
            --font-ui: 'Quicksand', sans-serif; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-cream);
            height: 100vh; width: 100vw;
            overflow: hidden;
            color: var(--text-purple);
            font-family: var(--font-ui);
            display: flex; justify-content: center; align-items: center;
        }

        #monitor {
            width: 100%; height: 100%;
            position: relative;
            background: radial-gradient(circle at 10% 20%, var(--blob-blue) 0%, transparent 40%),
                        radial-gradient(circle at 90% 80%, var(--star-pink) 0%, transparent 40%);
            background-color: var(--bg-cream);
        }

        /* SCREENS */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s ease;
            z-index: 10;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        /* HOME */
        #screen-home { justify-content: center; align-items: center; text-align: center; }
        .main-title {
            font-family: var(--font-head);
            font-size: 5rem; color: var(--star-pink);
            line-height: 1.2; text-shadow: 3px 3px 0px var(--text-purple);
            transform: rotate(-5deg); margin-bottom: 40px;
        }
        .sub-title {
            font-family: var(--font-head); font-size: 2.5rem; color: var(--blob-blue);
            text-shadow: 2px 2px 0px var(--text-purple); margin-top: -30px; margin-bottom: 50px; transform: rotate(3deg);
        }

        .btn-coin {
            background: var(--ui-white); border: 3px solid var(--text-purple); border-radius: 50px;
            padding: 15px 60px; color: var(--text-purple);
            font-family: var(--font-ui); font-size: 1.5rem; font-weight: 700; cursor: pointer; 
            box-shadow: 6px 6px 0px var(--blob-blue); transition: 0.2s;
        }
        .btn-coin:active { transform: translate(3px, 3px); box-shadow: 3px 3px 0px var(--blob-blue); }
        .blink-text { animation: blink 1.5s infinite; }
        @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.5;} }

        /* FRAMES */
        #screen-frames {
            justify-content: center; align-items: center; 
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px); padding: 20px;
        }
        .frame-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; max-width: 500px; }
        .btn-frame {
            background: var(--ui-white); border: 3px solid var(--text-purple); color: var(--text-purple);
            padding: 20px; text-align: center; cursor: pointer;
            font-family: var(--font-ui); font-size: 1.1rem; font-weight: bold; border-radius: 20px; 
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            box-shadow: 5px 5px 0 var(--star-pink); transition: 0.2s;
        }
        .btn-frame:active { transform: translate(2px, 2px); box-shadow: 3px 3px 0 var(--star-pink); background: var(--bg-cream); }
        .btn-frame.special { grid-column: span 2; background: var(--blob-blue); color: #fff; text-shadow: 1px 1px 0 var(--text-purple); }

        /* CAM */
        #screen-cam { justify-content: space-between; background: var(--bg-cream); }
        .ui-top {
            height: 70px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 25px; background: var(--blob-blue); border-bottom: 3px solid var(--text-purple);
            font-family: var(--font-ui); font-size: 1.5rem; font-weight: bold; color: var(--text-purple);
        }
        .viewport { flex: 1; position: relative; overflow: hidden; background: #000; border: 8px solid var(--ui-white); margin: 10px; border-radius: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        video#video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            font-size: 10rem; font-weight: 800; color: var(--ui-white); display: none;
            text-shadow: 5px 5px 0 var(--star-pink), -5px -5px 0 var(--blob-blue);
            font-family: var(--font-head);
        }
        .ui-controls {
            height: 150px; background: var(--ui-white); border-top: 3px solid var(--text-purple);
            display: flex; align-items: center; justify-content: center; gap: 20px;
        }
        .btn-filter {
            width: 60px; height: 60px; background: var(--bg-cream); border: 2px solid var(--text-purple);
            color: var(--text-purple); border-radius: 50%; cursor: pointer;
            font-family: var(--font-ui); font-weight: bold; font-size: 0.8rem;
        }
        .btn-filter.active { background: var(--star-pink); color: white; transform: scale(1.1); }
        .btn-shutter {
            width: 90px; height: 90px; border: 4px solid var(--text-purple); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer; background: var(--ui-white);
        }
        .shutter-inner { width: 70px; height: 70px; background: var(--star-pink); border-radius: 50%; transition: 0.1s; border: 2px solid var(--text-purple);}
        .btn-shutter:active .shutter-inner { transform: scale(0.9); background: var(--blob-blue); }

        /* RESULT */
        #screen-result { 
            justify-content: center; align-items: center; background: rgba(255,255,255,0.9);
            flex-direction: row; gap: 40px; padding: 20px;
        }
        .printer-slot {
            width: 340px; height: 65vh; border: 8px solid var(--ui-white); background: #fff;
            overflow: hidden; position: relative; box-shadow: 10px 10px 0px var(--blob-blue); border-radius: 10px;
        }
        .preview-img { width: 100%; height: auto; display: block; transform: translateY(105%); }
        .printing-active { animation: printSlide 4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes printSlide { 0% { transform: translateY(105%); } 100% { transform: translateY(0); } }

        .result-sidebar { display: flex; flex-direction: column; align-items: center; gap: 20px; opacity: 0; transition: opacity 1s ease 4s; width: 300px; }
        .result-sidebar.show { opacity: 1; }
        
        .server-log {
            font-family: var(--font-ui); color: var(--text-purple); width: 100%;
            background: var(--bg-cream); padding: 10px; border: 2px solid var(--text-purple);
            font-size: 1rem; margin-bottom: 10px; border-radius: 10px; font-weight: bold;
        }
        .loading-bar { height: 8px; background: #fff; width: 100%; margin-top: 5px; border-radius: 5px; overflow: hidden; border:1px solid var(--text-purple); }
        .loading-fill { height:100%; background: var(--star-pink); width: 0%; transition: width 0.2s; }
        
        .qr-container {
            background: var(--ui-white); padding: 15px; border: 3px solid var(--text-purple);
            text-align: center; display: none; border-radius: 20px; box-shadow: 6px 6px 0 var(--star-pink);
        }
        .qr-container.show { display: block; animation: popIn 0.5s ease; }
        @keyframes popIn { 0%{transform:scale(0.8); opacity:0;} 100%{transform:scale(1); opacity:1;} }
        .qr-text { color: var(--text-purple); font-family: var(--font-ui); font-size: 1.1rem; margin-top: 10px; font-weight: 800; }

        .action-btns { display: flex; flex-direction: column; gap: 15px; width: 100%; margin-top: 20px; }
        .btn-action {
            padding: 15px 40px; font-family: var(--font-ui); font-weight: 700;
            background: var(--blob-blue); color: var(--ui-white); border: 3px solid var(--text-purple); 
            cursor: pointer; font-size: 1rem; width: 100%; border-radius: 50px;
            box-shadow: 4px 4px 0 var(--text-purple); transition: 0.1s;
        }
        .btn-action:active { transform: translate(2px,2px); box-shadow: 2px 2px 0 var(--text-purple); }
        .btn-action.outline { background: var(--ui-white); color: var(--text-purple); }

        #flash { position: fixed; inset: 0; background: #fff; z-index: 999; opacity: 0; pointer-events: none; }
        .do-flash { animation: flashAnim 0.2s linear; }
        @keyframes flashAnim { 0%,100%{opacity:0;} 50%{opacity:1;} }
        
        @media (max-width: 800px) {
            #screen-result { flex-direction: column; gap: 20px; padding-top: 60px;}
            .printer-slot { height: 50vh; width: 80vw; }
            .result-sidebar { width: 80vw; transition-delay: 3s; }
            .action-btns { flex-direction: row; }
        }
    </style>
</head>
<body>

    <div id="monitor">
        <div id="screen-home" class="screen active">
            <div class="main-title">Better days<br>are coming</div>
            <div class="sub-title">Photo Booth</div>
            <button class="btn-coin" onclick="OS.start()">
                <span class="blink-text">START</span>
            </button>
            <p style="margin-top:20px; font-weight:bold; color:var(--text-purple); opacity:0.6;">CREDIT 0/1</p>
        </div>

        <div id="screen-frames" class="screen">
            <h2 style="font-family:var(--font-head); font-size:3rem; color:var(--text-purple); margin-bottom:30px; text-shadow:2px 2px 0 #fff;">Pick a Vibe</h2>
            <div class="frame-grid">
                <div class="btn-frame special" onclick="OS.selectFrame('emoji_pop')">
                    <span style="font-size:2rem">ü´ßü•£üéà</span>
                    <span>EMOJI POP</span>
                </div>
                <div class="btn-frame" onclick="OS.selectFrame('pastel_cloud')">
                    <span style="font-size:2rem">‚òÅÔ∏è‚ú®</span>
                    <span>PASTEL CLOUDS</span>
                </div>
                <div class="btn-frame" onclick="OS.selectFrame('simple_cute')">
                    <span style="font-size:2rem">üéÄ</span>
                    <span>SIMPLE CUTE</span>
                </div>
                <div class="btn-frame" onclick="OS.selectFrame('classic')">
                    <span style="font-size:2rem">üì∑</span>
                    <span>CLASSIC</span>
                </div>
            </div>
        </div>

        <div id="screen-cam" class="screen">
            <div class="ui-top">
                <div>üì∏ REC</div>
                <div id="clock">00:00</div>
            </div>
            <div class="viewport">
                <video id="video-feed" autoplay playsinline muted></video>
                <div id="countdown">3</div>
            </div>
            <div class="ui-controls">
                <button class="btn-filter active" onclick="OS.filter('color', this)">Normal</button>
                <button class="btn-filter" onclick="OS.filter('soft', this)">Soft</button>
                <button class="btn-filter" onclick="OS.filter('bw', this)">B/W</button>
                <div class="btn-shutter" onclick="OS.snap()">
                    <div class="shutter-inner"></div>
                </div>
                <div style="width:60px"></div>
            </div>
        </div>

        <div id="screen-result" class="screen">
            <div class="printer-wrapper">
                <div class="printer-slot">
                    <img id="final-img" class="preview-img" alt="Print">
                </div>
            </div>
            <div class="result-sidebar" id="res-sidebar">
                <div class="server-log" id="server-status">
                    <div id="log-text">Making magic... ‚ú®</div>
                    <div class="loading-bar"><div class="loading-fill" id="load-fill"></div></div>
                </div>
                <div class="qr-container" id="qr-box">
                    <div id="qrcode"></div>
                    <div class="qr-text" id="qr-status-text">SCAN ME!</div>
                </div>
                <div class="action-btns">
                    <button class="btn-action" onclick="OS.download()">Save Picture</button>
                    <button class="btn-action outline" onclick="location.reload()">Take Another</button>
                </div>
            </div>
        </div>
    </div>

    <div id="flash"></div>
    <canvas id="hidden-canvas" style="display:none"></canvas>

    <script>
        const OS = (function() {
            
            const API_KEY = 'ffc90ad0bc5c7e0c056b68ef7430304a'; 
            
            const C = {
                w: 1280, h: 720,
                stripW: 600,
                shots: 3, 
                quotes: ["Better days are coming", "You are magic ‚ú®", "Good Vibes Only", "So lovely!", "Dream Big"]
            };

            let s = { 
                filter: 'color', 
                frame: 'pastel', 
                photos: [], 
                stream: null, 
                processing: false 
            };

            const D = {
                screens: {
                    home: document.getElementById('screen-home'),
                    frames: document.getElementById('screen-frames'),
                    cam: document.getElementById('screen-cam'),
                    res: document.getElementById('screen-result')
                },
                video: document.getElementById('video-feed'),
                canvas: document.getElementById('hidden-canvas'),
                count: document.getElementById('countdown'),
                flash: document.getElementById('flash'),
                final: document.getElementById('final-img'),
                clock: document.getElementById('clock'),
                sidebar: document.getElementById('res-sidebar'),
                serverStatus: document.getElementById('server-status'),
                logText: document.getElementById('log-text'),
                loadFill: document.getElementById('load-fill'),
                qrBox: document.getElementById('qr-box')
            };

            const Aud = {
                ctx: null,
                init: function() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
                play: function(type) {
                    try {
                        this.init();
                        const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                        o.connect(g); g.connect(this.ctx.destination);
                        if(type === 'coin') { o.type='sine'; o.frequency.value = 800; g.gain.value = 0.1; o.start(); o.frequency.exponentialRampToValueAtTime(1200, this.ctx.currentTime+0.2); o.stop(this.ctx.currentTime+0.3); }
                        else if(type === 'beep') { o.type='triangle'; o.frequency.value = 1000; g.gain.value = 0.05; o.start(); o.stop(this.ctx.currentTime+0.1); }
                        else if(type === 'shutter') { o.type='square'; o.frequency.value = 200; g.gain.value = 0.1; o.start(); o.stop(this.ctx.currentTime+0.1); }
                        else if(type === 'print') {
                            o.type='triangle'; o.frequency.value = 300; g.gain.value = 0.05; 
                            o.start(); o.stop(this.ctx.currentTime + 3.0);
                        }
                    } catch(e) { console.log('Audio blocked'); }
                }
            };

            setInterval(() => {
                const d = new Date();
                D.clock.innerText = d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
            }, 1000);

            async function start() {
                Aud.play('coin');
                D.screens.home.classList.remove('active');
                D.screens.frames.classList.add('active');
            }

            async function selectFrame(type) {
                s.frame = type;
                Aud.play('beep');
                try {
                    s.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: C.w, height: C.h } });
                    D.video.srcObject = s.stream;
                    D.screens.frames.classList.remove('active');
                    D.screens.cam.classList.add('active');
                } catch(e) { 
                    alert("Camera Error: Please allow camera access and use HTTPS/Localhost."); 
                    console.error(e);
                }
            }

            function filter(mode, btn) {
                s.filter = mode;
                document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                let css = 'none';
                if(mode==='bw') css = 'grayscale(100%) contrast(1.1)';
                if(mode==='soft') css = 'saturate(0.8) brightness(1.1) contrast(0.9)';
                D.video.style.filter = css;
                Aud.play('beep');
            }

            async function snap() {
                if(s.processing) return;
                s.processing = true; s.photos = [];
                for(let i=0; i<C.shots; i++) {
                    await countdown(3);
                    await capture();
                    await new Promise(r => setTimeout(r, 800));
                }
                process();
            }

            function countdown(n) {
                return new Promise(r => {
                    let c = n; D.count.style.display = 'block'; D.count.innerText = c;
                    const t = setInterval(() => {
                        Aud.play('beep'); c--;
                        if(c>0) D.count.innerText = c;
                        else { clearInterval(t); D.count.style.display = 'none'; r(); }
                    }, 1000);
                });
            }

            function capture() {
                return new Promise(r => {
                    Aud.play('shutter');
                    D.flash.classList.add('do-flash');
                    setTimeout(() => D.flash.classList.remove('do-flash'), 200);
                    const cvs = document.createElement('canvas');
                    cvs.width = D.video.videoWidth; cvs.height = D.video.videoHeight;
                    const ctx = cvs.getContext('2d');
                    ctx.translate(cvs.width, 0); ctx.scale(-1, 1);
                    ctx.drawImage(D.video, 0, 0);
                    
                    if(s.filter !== 'color') {
                        const id = ctx.getImageData(0,0,cvs.width,cvs.height);
                        const d = id.data;
                        for(let i=0; i<d.length; i+=4) {
                            const R=d[i], G=d[i+1], B=d[i+2];
                            if(s.filter === 'bw') {
                                const v = 0.299*R + 0.587*G + 0.114*B;
                                d[i]=d[i+1]=d[i+2]=v;
                            } else if(s.filter === 'soft') {
                                d[i] = R*1.05 + 10; d[i+1] = G*1.02 + 10; d[i+2] = B*1.05 + 10; 
                            }
                        }
                        ctx.putImageData(id, 0, 0);
                    }
                    s.photos.push(cvs);
                    setTimeout(r, 200);
                });
            }

            // --- FIXED: Custom function to draw rounded rects (Works on all browsers) ---
            function drawRoundedRect(ctx, x, y, w, h, r) {
                if (w < 2 * r) r = w / 2;
                if (h < 2 * r) r = h / 2;
                ctx.beginPath();
                ctx.moveTo(x + r, y);
                ctx.arcTo(x + w, y, x + w, y + h, r);
                ctx.arcTo(x + w, y + h, x, y + h, r);
                ctx.arcTo(x, y + h, x, y, r);
                ctx.arcTo(x, y, x + w, y, r);
                ctx.closePath();
                ctx.fill();
            }

            function drawEmojiBackground(ctx, w, h) {
                ctx.fillStyle = '#FCF9D9';
                ctx.fillRect(0,0,w,h);
                const emojis = ["ü´ß", "ü•£", "üéà", "üé®", "üëÄ", "‚ú®"];
                ctx.font = "40px Arial";
                ctx.globalAlpha = 0.6;
                for(let i=0; i<40; i++) {
                    const x = Math.random() * w;
                    const y = Math.random() * h;
                    const size = Math.random() * 30 + 20;
                    const angle = (Math.random() - 0.5);
                    const char = emojis[Math.floor(Math.random() * emojis.length)];
                    ctx.save();
                    ctx.translate(x, y);
                    ctx.rotate(angle);
                    ctx.font = size + "px Arial";
                    ctx.fillText(char, 0, 0);
                    ctx.restore();
                }
                ctx.globalAlpha = 1.0;
            }

            function drawCloudBlob(ctx, x, y, w, h, color) {
                ctx.fillStyle = color;
                // Use the custom function instead of native roundRect
                drawRoundedRect(ctx, x, y, w, h, 60); 
            }

            function process() {
                try {
                    if(s.stream) s.stream.getTracks().forEach(t=>t.stop());

                    const f = s.frame;
                    let stripW = C.stripW; 
                    let photoW = 500, photoH = (photoW*3)/4;
                    let gap = 30, head = 180, foot = 120;
                    let H = head + (photoH*C.shots) + (gap*(C.shots-1)) + foot;

                    D.canvas.width = stripW; D.canvas.height = H;
                    const ctx = D.canvas.getContext('2d');

                    // 1. BACKGROUND
                    if(f === 'emoji_pop') {
                        drawEmojiBackground(ctx, stripW, H);
                    } else if(f === 'pastel_cloud') {
                        ctx.fillStyle = '#FCF9D9'; ctx.fillRect(0,0,stripW,H); 
                        ctx.fillStyle = '#A3D8E2';
                        ctx.beginPath(); ctx.arc(0, 200, 150, 0, Math.PI*2); ctx.fill();
                        ctx.beginPath(); ctx.arc(stripW, 600, 200, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = '#F5A3C7'; 
                        ctx.beginPath(); ctx.arc(100, H-100, 50, 0, Math.PI*2); ctx.fill();
                    } else if(f === 'simple_cute') { 
                        ctx.fillStyle = '#FFEFF5'; ctx.fillRect(0,0,stripW,H); 
                    } else { 
                        ctx.fillStyle = '#fff'; ctx.fillRect(0,0,stripW,H); 
                    }

                    // 2. HEADER
                    ctx.textAlign = 'center';
                    ctx.shadowColor = "#5E4B8B"; ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;
                    ctx.fillStyle = '#F5A3C7'; 
                    ctx.font = '70px "Pacifico"'; 
                    
                    if(f === 'emoji_pop') {
                        ctx.fillText('Better', stripW/2, 90);
                        ctx.fillStyle = '#A3D8E2'; 
                        ctx.fillText('days...', stripW/2, 160);
                    } else {
                        ctx.fillText('SENA', stripW/2, 90);
                        ctx.font = '40px "Quicksand"'; ctx.fillStyle = '#A3D8E2';
                        ctx.fillText('PHOTOBOOTH', stripW/2, 140);
                    }
                    ctx.shadowColor = "transparent"; 

                    // 3. PHOTOS
                    let y = head;
                    s.photos.forEach(p => {
                        const sR = p.width/p.height; const dR=4/3;
                        let sx, sy, sw, sh;
                        if(sR > dR) { sh=p.height; sw=sh*dR; sx=(p.width-sw)/2; sy=0; }
                        else { sw=p.width; sh=sw/dR; sx=0; sy=(p.height-sh)/2; }
                        
                        // Frame BG (using safe custom function)
                        ctx.fillStyle = '#fff';
                        drawRoundedRect(ctx, (stripW-photoW)/2 - 10, y - 10, photoW + 20, photoH + 20, 10);
                        
                        // Outline
                        ctx.strokeStyle = '#5E4B8B'; ctx.lineWidth = 2;
                        ctx.stroke();

                        ctx.drawImage(p, sx, sy, sw, sh, (stripW-photoW)/2, y, photoW, photoH);
                        y += photoH + gap;
                    });

                    // 4. FOOTER
                    const quote = C.quotes[Math.floor(Math.random()*C.quotes.length)];
                    ctx.font = 'bold 30px "Pacifico"'; 
                    ctx.textAlign = 'center'; 
                    ctx.fillStyle = '#5E4B8B';

                    const date = new Date().toLocaleDateString('en-GB');
                    if(f === 'emoji_pop') {
                        ctx.fillText("are coming. ‚ú®", stripW/2, H - 50);
                    } else {
                        ctx.fillText(`${date} ‚Ä¢ ${quote}`, stripW/2, H - 50);
                    }

                    // RENDER
                    const finalDataUrl = D.canvas.toDataURL('image/jpeg', 0.9);
                    D.final.src = finalDataUrl;
                    
                    D.screens.cam.classList.remove('active');
                    D.screens.res.classList.add('active');
                    
                    Aud.play('print');
                    D.final.classList.add('printing-active');
                    
                    setTimeout(() => { 
                        D.sidebar.classList.add('show'); 
                        handleUpload(finalDataUrl); 
                    }, 3500);

                } catch(e) {
                    console.error("Rendering Error:", e);
                    alert("Error creating image. Please try again.");
                }
            }

            async function handleUpload(base64Image) {
                let p = 0;
                const int = setInterval(() => {
                    p += Math.random() * 15;
                    if(p > 90) clearInterval(int);
                    else D.loadFill.style.width = p + "%";
                }, 200);

                try {
                    const cleanBase64 = base64Image.split(',')[1];
                    const formData = new FormData();
                    formData.append("image", cleanBase64);

                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
                        method: 'POST',
                        body: formData
                    });
                    const data = await res.json();

                    clearInterval(int);
                    D.loadFill.style.width = "100%";

                    if(data.success) {
                        D.logText.innerText = "Upload Complete! ‚ú®";
                        generateQR(data.data.url);
                        setTimeout(() => {
                            D.serverStatus.style.display = 'none';
                            D.qrBox.classList.add('show');
                        }, 500);
                    } else { throw new Error('API Error'); }
                } catch(e) {
                    console.log(e);
                    D.logText.innerText = "Offline Mode (Saved Locally)";
                    generateQR(window.location.href); 
                    D.qrBox.classList.add('show');
                }
            }

            function generateQR(url) {
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById("qrcode"), {
                    text: url, 
                    width: 140, height: 140,
                    colorDark : "#5E4B8B", colorLight : "#fff",
                    correctLevel : QRCode.CorrectLevel.L
                });
            }

            function download() {
                const a = document.createElement('a');
                a.download = `SENA_DREAMY_${Date.now()}.jpg`;
                a.href = D.canvas.toDataURL('image/jpeg', 1.0);
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }

            return { start, selectFrame, filter, snap, download };
        })();
    </script>
</body>
</html>
